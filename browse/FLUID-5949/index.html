<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-5949  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-5949 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-5949/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-5949/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-5949/">FLUID-5949</a></li>
            </ol>
        </nav>
        <h1>FLUID-5949: Improve IoC testing framework so that it can accept fixture types dispensing promises</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-5949">FLUID-5949</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Improvement">Improvement</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Fixed">Fixed</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2016-09-01T12:04:45.178-0400" prefix="">2016-09-01T12:04:45.178-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2024-07-22T09:22:48.208-0400" prefix="">2024-07-22T09:22:48.208-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>2.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Testing Infrastructure</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>A lot of asynchronous components which rely on the IoC Testing framework has been forced to expose top-level events which mirror the sequence points of promises dispensed from their APIs. Whilst this is apparently helpful for configuration purposes, as a general practice this is not only verbose but rather unsafe. It creates the impression that an event can be relied upon as a signal for the termination of <strong>a particular process</strong> when it can't - without some extra information such as a request or a transaction id, it can only signal the termination of <strong>a particular type of process</strong>.</p>
<p>In order to head this off, and also to assist the widespread promise-based APIs that we are now producing until we can assimilate all of this activity behind a "megapayloadic idiom", we should produce a new fixture type in the IoC testing framework which accepts promises - this would be, from the framework's point of view, a mixed "active/passive" type of record.</p>
<p>Suggested structure is a member called "task" which is of type "function returning promise", with args at top level, and then two "listener" type records named onReject, onResolve </p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-22147">
                        <p class="mb-0"><b>Simon Bates</b> <i>commented <relative-time datetime="2016-10-11T14:14:28.787-0400">2016-10-11T14:14:28.787-0400</relative-time></i></p>
                        <p>Merged at <a href="https://github.com/fluid-project/infusion/commit/499e6098c0151226c0989dbdc263b43635ca4521">https://github.com/fluid-project/infusion/commit/499e6098c0151226c0989dbdc263b43635ca4521</a></p>

                    </li>
                    
                    <li id="comment-22150">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2016-10-14T07:41:21.204-0400">2016-10-14T07:41:21.204-0400</relative-time></i></p>
                        <p>Is there a companion PR to document the new "task" construct?  If not, I can probably submit one based on my reading of <a href="https://github.com/fluid-project/infusion/blob/499e6098c0151226c0989dbdc263b43635ca4521/tests/test-core/testTests/js/IoCTestingTests.js#L440">the new tests</a>.</p>

                    </li>
                    
                    <li id="comment-22151">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2016-10-15T21:36:27.573-0400">2016-10-15T21:36:27.573-0400</relative-time></i></p>
                        <p>Tony Atkins [RtF] - that would be incredibly welcome, yes!</p>

                    </li>
                    
                    <li id="comment-22154">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2016-10-17T08:07:59.084-0400">2016-10-17T08:07:59.084-0400</relative-time></i></p>
                        <p>Antranig Basman, where would you like this to live?  Is it a new top-level concept that is useful beyond tests ("The Task API") or a part only of the IoC test framework?</p>

                    </li>
                    
                    <li id="comment-22156">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2016-10-24T22:25:16.266-0400">2016-10-24T22:25:16.266-0400</relative-time></i></p>
                        <p>Not to worry, Tony Atkins [RtF], I am taking care of these docs as part of the <a href="/browse/FLUID-5903/">FLUID-5903</a> docs pull - thanks for the offer!</p>

                    </li>
                    
                    <li id="comment-22159">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2016-11-10T09:15:55.073-0500">2016-11-10T09:15:55.073-0500</relative-time></i></p>
                        <p>Antranig Basman, I am starting to use this more in working with gpii-webdriver, which commonly returns promise-generating objects from various calls, and have a question.  Can a "task" be launched in response to an event?</p>
<p>Specifically, I am finding elements that are WebElement objects:</p>
<p><a href="http://seleniumhq.github.io/selenium/docs/api/javascript/module/selenium-webdriver/index_exports_WebElement.html">http://seleniumhq.github.io/selenium/docs/api/javascript/module/selenium-webdriver/index_exports_WebElement.html</a></p>
<p>The returned promise-generating object is available as <code>{arguments}.0</code> in the next sequence step, I would ideally like to use <code>{arguments}.0.isSelected</code> or the like as the <code>listener</code> for a given event, and then to check its result using <code>resolve</code> and <code>reject</code>.  <a href="https://github.com/fluid-project/infusion/commit/499e6098c0151226c0989dbdc263b43635ca4521">The new tests</a> don't have an example of doing this.</p>
<p>This pattern mixes old-style promises that eventually fire an event with the new construct.  My other option is to chain promises, which also does not seem possible.</p>
<p>Anyway, please advise.</p>

                    </li>
                    
                    <li id="comment-22164">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2016-11-11T12:45:50.988-0500">2016-11-11T12:45:50.988-0500</relative-time></i></p>
                        <p>Thanks, Tony Atkins [RtF] - this is an interesting suggestion. Do you think you could flesh it out with a specific example of a sequence you would want, either in old-fashioned JS or else in configuration (preferably both!) - cheers</p>

                    </li>
                    
                    <li id="comment-22168">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2016-11-17T08:00:20.590-0500">2016-11-17T08:00:20.590-0500</relative-time></i></p>
                        <p>Antranig Basman, here (from the webdriver docs) is the simplest example of retrieving a page, clicking a link, and waiting until the title is correct:</p>
<pre><code class="hljs language-java">driver.get(<span class="hljs-string">'http://www.google.com/ncr'</span>);
driver.findElement(By.name(<span class="hljs-string">'q'</span>)).sendKeys(<span class="hljs-string">'webdriver'</span>);
driver.findElement(By.name(<span class="hljs-string">'btnG'</span>)).click();
driver.wait(until.titleIs(<span class="hljs-string">'webdriver - Google Search'</span>), <span class="hljs-number">1000</span>);
driver.quit();
</code></pre>
<p>Currently, I have no way of accessing elements of WebElement, such as "sendKeys" above, and then getting control back.  My solution thus far has been to create an <a href="https://github.com/the-t-in-rtf/gpii-webdriver/blob/GPII-1889/docs/webdriver.md#thatactionshelperactionsarray">actionsHelper</a> that wraps these kinds of interactions. </p>
<pre><code class="hljs language-java">{ func: <span class="hljs-string">"{testEnvironment}.webdriver.get"</span>, args: [<span class="hljs-string">"http://www.google.com/ncr"</span>] },
{ event: <span class="hljs-string">"{testEnvironment}.webdriver.events.onGetComplete"</span>, listener: <span class="hljs-string">"{testEnvironment}.webdriver.findElement"</span>, args: [gpii.webdriver.By.name(<span class="hljs-string">"q"</span>)] },
{
  event: <span class="hljs-string">"{testEnvironment}.webdriver.events.onFindElementComplete"</span>,
  listener: <span class="hljs-string">"{testEnvironment}.webdriver.actionsHelper"</span>,
  args:     [{ fn: <span class="hljs-string">"sendKeys"</span>, args: [<span class="hljs-string">"webdriver"</span>]}],
},
{
  event: <span class="hljs-string">"{testEnvironment}.webdriver.events.onActionsHelperComplete"</span>,
  listener: <span class="hljs-string">"{testEnvironment}.webdriver.findElement"</span>,
  args: [gpii.webdriver.By.name(<span class="hljs-string">"btnG"</span>)]
},
{
  event: <span class="hljs-string">"{testEnvironment}.events.onFindElementComplete"</span>,
  listener: <span class="hljs-string">"{testEnvironment}.webdriver.actionsHelper"</span>,
  args: [{ fn: <span class="hljs-string">"click"</span>, args: [<span class="hljs-string">"{arguments}.0"</span>]}] 
},
{
  event: <span class="hljs-string">"{testEnvironment}.webdriver.events.onActionsHelperComplete"</span>,
  listener: <span class="hljs-string">"{testEnvironment}.webdriver.wait"</span>,
  args: [gpii.webdriver.until.titleIs(<span class="hljs-string">"webdriver - Google Search"</span>), <span class="hljs-number">1000</span>]
},
{
  event: <span class="hljs-string">"{testEnvironment}.webdriver.events.onWaitComplete"</span>,
  listener: <span class="hljs-string">"jqUnit.assert"</span>,
  args: [<span class="hljs-string">"The title should have been updated..."</span>]
}
</code></pre>
<p>The pattern is really calling a component, getting an arbitrary object back,  calling one of its promise-returning methods, and continuing once that promise completes.  There may be multiple links in the chain before I get to a state where I can listen for known events or call my own functions again.  For example, I might be clicking an inline edit in the above example and then sending keys to the same element.</p>
<p>I can see mitigating this by having fluid.promise components to connect the gaps, for example:</p>
<ol>
<li>I call a named function that fires a known event, such as findElement.</li>
<li>I listen for onFindElementComplete.  The results of that event are an object with promise-generating promises (such as the WebElement returned by findElement above).</li>
<li>Within the same sequence step, I use {arguments}.0.sendKeys as my "task", and use "{promiseComponent}.resolve" as my listener.</li>
<li>The next sequence step then uses "{promiseComponent}.then" as a task and either another promise component or a known function as "resolve".</li>
</ol>
<p>This assumes that I can mix events and tasks somehow, which doesn't seem possible at the moment, and still seems convoluted.  Even that would be something, as it would reduce the number of cases in which I need to write wrappers for returned objects with promise-generating functions.</p>
<p>Anyway, hope that makes sense at all.</p>

                    </li>
                    
                    <li id="comment-22175">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2016-11-18T09:22:32.809-0500">2016-11-18T09:22:32.809-0500</relative-time></i></p>
                        <p>Just to give another example of what I need better promise handling for:</p>
<p><a href="https://github.com/the-t-in-rtf/gpii-webdriver/blob/GPII-1889/src/tests/helper-functions.js#L24">https://github.com/the-t-in-rtf/gpii-webdriver/blob/GPII-1889/src/tests/helper-functions.js#L24</a></p>
<p>This function is used to hit "WebElement" functions and inspect the results, I'm commonly working with the return value of a "findElement" call.  I use the function to do things like check visibility (using the returned "WebElement" object's "isDisplayed" method).</p>

                    </li>
                    
                    <li id="comment-22180">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2016-11-20T21:14:08.169-0500">2016-11-20T21:14:08.169-0500</relative-time></i></p>
                        <p>I think there's nothing we can do about this in terms of extending the core IoC testing framework configuration primitives - I can't see there is any natural way of doing this that doesn't lead us to an "infinite regress" situation of imagining variants that handle "promise-dispensing promise-dispensing promises" etc. The issue is that code like</p>
<pre><code class="hljs language-java">driver.findElement(By.name(<span class="hljs-string">'q'</span>)).sendKeys(<span class="hljs-string">'webdriver'</span>);
</code></pre>
<p>Looks very neat and intelligible, but covers a raft of authorial sins. Of course this syntax was <strong>designed</strong> to be isomorphic to the (synchronous) code which it replaced, so it is no surprise that it leads to the same issues.</p>
<p>What I think is the way out here is to replace both your "helpers" and in addition the lumps of sequence elements which act on them by "helper grades" of the kind that were implemented for <a href="https://issues.fluidproject.org/browse/FLUID-5903">https://issues.fluidproject.org/browse/FLUID-5903</a> - for which the docs are in review at <a href="https://github.com/fluid-project/infusion-docs/pull/103">https://github.com/fluid-project/infusion-docs/pull/103</a> - any comments welcome.<br>
This should enable you to make a syntax which is i) still relatively compact, but ii) authorially open - in the sense that someone could take parts of your sequences and replace parts of them with other expressions for reuse in other test fixtures.</p>
<p>I appreciate this might not look like the most straightforward thing in the world - since noone has so far used the <a href="/browse/FLUID-5903/">FLUID-5903</a> facility in the wild. But there is a first time for everything! We should talk this over - perhaps even at a topic meeting or so, since I have been meaning to get people up to speed with this facility for a while - we've accumulated years worth of stovepipe test sequences that need refactoring.</p>

                    </li>
                    
                    <li id="comment-22186">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2016-11-21T03:38:07.613-0500">2016-11-21T03:38:07.613-0500</relative-time></i></p>
                        <p>Thanks, Antranig Basman.  I will read through both and think about the new approach.  It may be that something like gpii-webdriver (or packages that use gpii-webdriver in their tests) are a good place to experiment with this, as I am struggling with exactly the reuse issues you mention regarding arrays in writing browser-driving tests.</p>
<p>I suggest announcing it at the arch meeting and either discussing there or at least getting a show of hands for participants.  If we can't manage to arrange a meeting before, IMO we should have a breakout session as part of the offsite.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-5948/"><span class="aria-hidden">←</span> Previous: FLUID-5948</a>
        <a class="mx-1" href="/browse/FLUID-5950/">Next: FLUID-5950 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>