<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> INFRA-162  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" INFRA-162 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/INFRA-162/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/INFRA-162/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/INFRA" data-pagefind-filter="project">Infrastructure</a></li>
                <li><a href="/browse/INFRA-162/">INFRA-162</a></li>
            </ol>
        </nav>
        <h1>INFRA-162: Increase BuildKite parallelism</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/INFRA-162">INFRA-162</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/INFRA/?type=Improvement">Improvement</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/INFRA/?resolution=Won't%20Fix">Won't Fix</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Giovanni Tirloni</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/INFRA/?reporter=Giovanni%20Tirloni">Giovanni Tirloni</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2018-04-12T11:36:28.307-0400" prefix="">2018-04-12T11:36:28.307-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2018-08-29T13:24:13.664-0400" prefix="">2018-08-29T13:24:13.664-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>BuildKite's agent works on a single build at once. To increase the parallelism and make effective use of all CPUs for our builds, more agents need to be started, per host.</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-25974">
                        <p class="mb-0"><b>Giovanni Tirloni</b> <i>commented <relative-time datetime="2018-04-13T08:51:41.233-0400">2018-04-13T08:51:41.233-0400</relative-time></i></p>
                        <h2>Job Concurrency</h2>
<p>While Jenkins lets you tweak the number of&#160;<a href="https://support.cloudbees.com/hc/en-us/articles/216456477-What-is-a-Jenkins-Executor-and-how-can-I-best-utilize-my-executors">executors</a>&#160;and GitLab lets you define how many&#160;<a href="https://docs.gitlab.com/runner/configuration/advanced-configuration.html">concurrent</a>&#160;jobs a runner supports, the Buildkite agent runs one job at a time. This makes it simpler and more robust, which are trade-offs I can agree with.</p>
<p>If you want to increase the job concurrency per host, you have to deploy multiple agents.</p>
<p>The official documentation is a bit light on details so I’ll add the steps I have followed to achieve this. My environment consists of CentOS hosts and the agents are started by systemd. I’ve tested these steps on&#160;<a href="https://building.buildkite.com/announcing-buildkite-agent-v3-0-4781a0e2d4db">buildkite-agent v3.0</a>.</p>
<p>The idea is to have a single agent configuration file with global settings for the host and tweak the per-agent settings using a systemd&#160;<a href="https://fedoramagazine.org/systemd-template-unit-files">unit template</a>, so you can easily instantiate as many units as needed.</p>
<p>The only settings you will need to define are the&#160;<code>token</code>&#160;and any&#160;<code>tags</code>&#160;you might need. Tags are useful when you need to define a different queue name or add meta-data about your hosts (e.g.&#160;<code>queue=priority,hypervisor=kvm,docker=true</code>) that can later be used to target jobs.</p>
<p>The minimum per-agent settings are:</p>
<ul>
<li>name</li>
<li>build-path</li>
<li>hooks-path</li>
<li>plugins-path</li>
</ul>
<p>As I’ve mentioned, the latter will be set automatically using systemd.</p>
<p>If you need to set per-host settings, use the configuration file. For per-agent settings, add them to the systemd unit file.</p>
<p>Another approach is to have per-agent configuration files instead of using systemd (and environment variables). For that, tweak the systemd unit file below to pass the&#160;<code>BUILDKITE_AGENT_CONFIG</code>&#160;environment variable or the&#160;<code>--config</code>&#160;parameter to&#160;<code>buildkite-agent start</code>.</p>
<h2>Steps</h2>
<p>First, install the agent following the official steps&#160;<a href="https://buildkite.com/docs/agent/v3/redhat">here</a>.</p>
<p>Edit the&#160;<code>/etc/buildkite-agent/buildkite-agent.cfg</code>&#160;file so it only has the following lines:</p>
<pre><code class="hljs"><span class="hljs-attr">token</span>=<span class="hljs-string">"xxx"</span>
<span class="hljs-attr">tags</span>=<span class="hljs-string">"tag1=value1,tag2=value2"</span>     <span class="hljs-comment"># optional</span>
</code></pre>
<p>In other words, ensure that per-agent settings like&#160;<code>name</code>,&#160;<code>build-path</code>,&#160;<code>hooks-path</code>&#160;and&#160;<code>plugins-path</code>&#160;are&#160;<strong>not</strong>&#160;defined in the configuration file.</p>
<p>Next, edit the&#160;<code>/usr/lib/systemd/system/buildkite-agent@.service</code>&#160;file and replace it with the following:</p>
<p></p>
<pre><code class="hljs"><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=Buildkite Agent (%i)
<span class="hljs-attr">Documentation</span>=https://buildkite.com/agent
<span class="hljs-attr">After</span>=syslog.target
<span class="hljs-attr">After</span>=network.target

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">Type</span>=simple
<span class="hljs-attr">User</span>=buildkite-agent
<span class="hljs-attr">PermissionsStartOnly</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">Environment</span>=HOME=/var/lib/buildkite-agent-%i
<span class="hljs-attr">Environment</span>=BUILDKITE_AGENT_NAME=%H-%i
<span class="hljs-attr">Environment</span>=BUILDKITE_BUILD_PATH=/var/lib/buildkite-agent-%i/builds
<span class="hljs-attr">Environment</span>=BUILDKITE_HOOKS_PATH=/etc/buildkite-agent/hooks
<span class="hljs-attr">Environment</span>=BUILDKITE_PLUGINS_PATH=/etc/buildkite-agent/plugins
<span class="hljs-attr">ExecStartPre</span>=/bin/mkdir -p /var/lib/buildkite-agent-%i/builds
<span class="hljs-attr">ExecStartPre</span>=/bin/chown -R buildkite-agent /var/lib/buildkite-agent-%i
<span class="hljs-attr">ExecStart</span>=/usr/bin/buildkite-agent start
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">5</span>
<span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure
<span class="hljs-attr">TimeoutSec</span>=<span class="hljs-number">10</span>

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
<span class="hljs-attr">DefaultInstance</span>=<span class="hljs-number">1</span>
</code></pre>
<p>Each agent will get a directory under /var/lib/buildkite-agent-%i where&#160;<code>%i</code>&#160;is the instance argument.</p>
<p>Reload the systemd configuration with&#160;<code>systemctl daemon-reload</code>.</p>
<p>Now you are ready to start as many agents as needed:</p>
<p></p>
<pre><code class="hljs"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> buildkite-agent@1.service</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl start buildkite-agent@1.service</span>
</code></pre>
<p>Repeat these steps and increase the instance numbers and you should see your agents appearing in the Buildkite&#160;<a href="https://buildkite.com/dashboard">dashboard</a></p>
<p>In case you want to change the agent name to something other than&#160;<code>%hostname-%instance</code>, ensure it’s set to something globally unique. For a list of systemd specifiers, see the&#160;<a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">official documentation</a>&#160;(table 4).</p>
<h2>Caveats</h2>
<p>It might seem unintuitive at first but Buildkite can schedule jobs from a single pipeline to different agents.</p>
<p>If all your pipeline steps need to run on the same host, you have to ensure that&#160;<strong>each</strong>&#160;step is properly targetted at that host using a combination of meta-data selectors (see the&#160;<code>agents</code>&#160;attribute for the&#160;{{command}}step).</p>
<p></p>
<pre><code class="hljs">- <span class="hljs-built_in">name</span>: build
    command: <span class="hljs-built_in">echo</span> <span class="hljs-string">'hello world'</span>
    <span class="hljs-built_in">agents</span>:
      <span class="hljs-built_in">name</span>: hostname
      queue: <span class="hljs-keyword">default</span>
</code></pre>
<p>There is a feature request to have per-pipeline agent rules so the agent doesn’t need to be specified per step (<a href="https://github.com/buildkite/feedback/issues/173">buildkite/feedback/issues/173</a>), which should simplify this.</p>
<p>Source: <a href="https://ret.cx/2018/04/running-multiple-buildkite-agents-per-host/">https://ret.cx/2018/04/running-multiple-buildkite-agents-per-host/</a></p>

                    </li>
                    
                    <li id="comment-25977">
                        <p class="mb-0"><b>Giovanni Tirloni</b> <i>commented <relative-time datetime="2018-04-13T09:05:51.613-0400">2018-04-13T09:05:51.613-0400</relative-time></i></p>
                        <p>Avtar Gill does this approach sound okay? I'm just worried about what I mentioned in the caveats section. That will make the pipeline.yml file look a bit ugly. Some people have tried to simplify it by turning the yaml into a shell script and then getting the agent's name and adding it to everything (so the step becomes "pipeline.sh | buildkite-agent upload pipeline"). If issue#173 would be implemented, that would be awesome but I'm not sure how long we'd have to wait for that.</p>
<p></p>
<p>I'm trying to think of a situation where running steps in different hosts would be beneficial, it's so different from the way we have been working for years now.</p>

                    </li>
                    
                    <li id="comment-25979">
                        <p class="mb-0"><b>Giovanni Tirloni</b> <i>commented <relative-time datetime="2018-04-16T20:54:16.520-0400">2018-04-16T20:54:16.520-0400</relative-time></i></p>
                        <p>Made some changes to the systemd unit file so it has the agent with separate users:</p>
<pre><code class="hljs"><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=Buildkite Agent (%i)
<span class="hljs-attr">Documentation</span>=https://buildkite.com/agent
<span class="hljs-attr">After</span>=syslog.target
<span class="hljs-attr">After</span>=network.target

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">Type</span>=simple
<span class="hljs-attr">User</span>=buildkite-agent-%i
<span class="hljs-attr">PermissionsStartOnly</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">Environment</span>=HOME=/home/buildkite-agent-%i
<span class="hljs-attr">Environment</span>=BUILDKITE_AGENT_NAME=%H-%i
<span class="hljs-attr">Environment</span>=BUILDKITE_BUILD_PATH=/home/buildkite-agent-%i/builds
<span class="hljs-attr">Environment</span>=BUILDKITE_HOOKS_PATH=/etc/buildkite-agent/hooks
<span class="hljs-attr">Environment</span>=BUILDKITE_PLUGINS_PATH=/etc/buildkite-agent/plugins
<span class="hljs-attr">ExecStartPre</span>=/bin/mkdir -p /home/buildkite-agent-%i/builds
<span class="hljs-attr">ExecStartPre</span>=/bin/chown -R buildkite-agent-%i /home/buildkite-agent-%i
<span class="hljs-attr">ExecStart</span>=/usr/bin/buildkite-agent start
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">5</span>
<span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure
<span class="hljs-attr">TimeoutSec</span>=<span class="hljs-number">10</span>

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
<span class="hljs-attr">DefaultInstance</span>=<span class="hljs-number">1</span>
</code></pre>
<pre><code class="hljs">useradd -g <span class="hljs-keyword">buildkite-agent </span><span class="hljs-keyword">buildkite-agent-1
</span></code></pre>

                    </li>
                    
                    <li id="comment-25981">
                        <p class="mb-0"><b>Justin Obara</b> <i>commented <relative-time datetime="2018-05-22T10:24:53.090-0400">2018-05-22T10:24:53.090-0400</relative-time></i></p>
                        <p>Merged PR ( <a href="https://github.com/fluid-project/infusion/pull/901">https://github.com/fluid-project/infusion/pull/901</a>&#160;) into the project repo at&#160;8b7038bd1c50df813748fe12cfb186b9ae8546ab</p>

                    </li>
                    
                    <li id="comment-25982">
                        <p class="mb-0"><b>Giovanni Tirloni</b> <i>commented <relative-time datetime="2018-05-22T12:21:17.866-0400">2018-05-22T12:21:17.866-0400</relative-time></i></p>
                        <p>Thanks Justin Obara! Now we can spin up new agents for other purposes and they won't interfere.</p>

                    </li>
                    
                    <li id="comment-25983">
                        <p class="mb-0"><b>Giovanni Tirloni</b> <i>commented <relative-time datetime="2018-05-24T16:27:47.060-0400">2018-05-24T16:27:47.060-0400</relative-time></i></p>
                        <p>Until the following features are implemented, it's necessary to define a tag 'name' in the agent configuration (through a env var, for automatic systemd configuration of the agent name) so we have information to properly target the agent:</p>
<ul>
<li><a href="https://github.com/buildkite/feedback/issues/173">https://github.com/buildkite/feedback/issues/173</a></li>
<li><a href="https://github.com/buildkite/agent/issues/773">https://github.com/buildkite/agent/issues/773</a></li>
</ul>
<p>Submitted a new PR with the necessary changes (<a href="https://github.com/fluid-project/infusion/pull/905">https://github.com/fluid-project/infusion/pull/905</a>)</p>
<p>Deployed 4 agents on h-0005.</p>
<p>This is the latest systemd unit file:</p>
<pre><code class="hljs"><span class="hljs-comment"># cat /usr/lib/systemd/system/buildkite@.service</span>
<span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=Buildkite Agent (%i)
<span class="hljs-attr">Documentation</span>=https://buildkite.com/agent
<span class="hljs-attr">After</span>=syslog.target
<span class="hljs-attr">After</span>=network.target

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">Type</span>=simple
<span class="hljs-attr">User</span>=buildkite-agent-%i
<span class="hljs-attr">PermissionsStartOnly</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">Environment</span>=HOME=/home/buildkite-agent-%i
<span class="hljs-attr">Environment</span>=BUILDKITE_AGENT_NAME=%H-%i
<span class="hljs-attr">Environment</span>=BUILDKITE_AGENT_TAGS=name=%H-%i,env=dev,type=physical,hypervisor=virtualbox,docker=<span class="hljs-literal">true</span>,vagrant=<span class="hljs-literal">true</span>
<span class="hljs-attr">Environment</span>=BUILDKITE_BUILD_PATH=/home/buildkite-agent-%i/builds
<span class="hljs-attr">Environment</span>=BUILDKITE_HOOKS_PATH=/etc/buildkite-agent/hooks
<span class="hljs-attr">Environment</span>=BUILDKITE_PLUGINS_PATH=/etc/buildkite-agent/plugins
<span class="hljs-attr">ExecStartPre</span>=/bin/mkdir -p /home/buildkite-agent-%i/builds
<span class="hljs-attr">ExecStartPre</span>=/bin/chown -R buildkite-agent-%i /home/buildkite-agent-%i/builds
<span class="hljs-attr">ExecStart</span>=/usr/bin/buildkite-agent start
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">5</span>
<span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure
<span class="hljs-attr">TimeoutSec</span>=<span class="hljs-number">10</span>

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
<span class="hljs-attr">DefaultInstance</span>=<span class="hljs-number">1</span>
</code></pre>

                    </li>
                    
                    <li id="comment-25984">
                        <p class="mb-0"><b>Giovanni Tirloni</b> <i>commented <relative-time datetime="2018-08-29T13:24:13.661-0400">2018-08-29T13:24:13.661-0400</relative-time></i></p>
                        <p>It's unlikely we will continue to use BuildKite at this point (and Jenkins has been configured for some Fluid projects already).</p>
<p>With that in mind, I've rolled back these changes and uninstalled buildkite-agent from h-0005.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/INFRA-161/"><span class="aria-hidden">←</span> Previous: INFRA-161</a>
        <a class="mx-1" href="/browse/INFRA-163/">Next: INFRA-163 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>