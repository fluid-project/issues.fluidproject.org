<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-5671  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-5671 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-5671/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-5671/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-5671/">FLUID-5671</a></li>
            </ol>
        </nav>
        <h1>FLUID-5671: Memory exhaustion is possible during fluid.fail on node.js</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-5671">FLUID-5671</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Fixed">Fixed</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2015-05-28T11:12:17.108-0400" prefix="">2015-05-28T11:12:17.108-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2017-02-27T15:49:16.998-0500" prefix="">2017-02-27T15:49:16.998-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>2.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Framework</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>Today we observed an "FATAL ERROR: JS Allocation failed - process out of memory" whilst debugging a node.js infusion (gpii-express - common terms registry) app. Eventually the fault was traced to the object rendering code triggered by the patched "fluid.doLog" implementation in fluid.js - this was formerly improved for <a href="/browse/FLUID-5475/">FLUID-5475</a>, but it clearly needs to be improved further:</p>
<p>// Convert an argument intended for console.log in the node environment to a readable form (the<br>
// default action of util.inspect censors at depth 1)<br>
fluid.renderLoggingArg = function (arg) {<br>
var togo = arg &amp;&amp; fluid.isPrimitive(arg) ? arg : fluid.prettyPrintJSON(arg);<br>
if (typeof(togo) === "string" &amp;&amp; togo.length &gt; fluid.logObjectRenderChars) {<br>
togo = togo.substring(0, fluid.logObjectRenderChars) + " .... [output suppressed at " + fluid.logObjectRenderChars + " chars - for more output, increase fluid.logObjectRenderChars]";<br>
}<br>
return togo;<br>
};</p>
<p>// Monkey-patch the built-in fluid.doLog utility to improve its behaviour within node.js - see <a href="/browse/FLUID-5475/">FLUID-5475</a><br>
fluid.doLog = function (args) {<br>
args = fluid.transform(args, fluid.renderLoggingArg);<br>
console.log(args.join(""));<br>
};</p>
<p>Whilst fluid.prettyPrintJSON does indeed resist rendering circular objects, and we truncate its output to avoid flooding the console, it is still possible for extremely highly tangled objects, of the kinds found within node-express, to cause memory exhaustion when we try to render them. A sample of these is rendered in the following gist - <a href="https://gist.github.com/amb26/e343c89980d6d9be39ec">https://gist.github.com/amb26/e343c89980d6d9be39ec</a> </p>
<p>we should improve fluid.prettyPrintJSON so that it can apply an output limit whilst streaming.</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-22530">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2015-08-20T14:18:49.588-0400">2015-08-20T14:18:49.588-0400</relative-time></i></p>
                        <p>Merged into trunk at revision 282f1a318718eed0b0ec060fb8b4ad254417fd7e</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-5670/"><span class="aria-hidden">←</span> Previous: FLUID-5670</a>
        <a class="mx-1" href="/browse/FLUID-5672/">Next: FLUID-5672 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>