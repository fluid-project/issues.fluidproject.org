<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> SJRK-400  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" SJRK-400 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/SJRK-400/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/SJRK-400/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/SJRK" data-pagefind-filter="project">Social Justice Repair Kit</a></li>
                <li><a href="/browse/SJRK-400/">SJRK-400</a></li>
            </ol>
        </nav>
        <h1>SJRK-400: singleFileUploader is undefined when removing media blocks</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/SJRK-400">SJRK-400</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/SJRK/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Open</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>N/A</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/SJRK/?reporter=Gregor%20Moss">Gregor Moss</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2020-10-20T20:50:25.058-0400" prefix="">2020-10-20T20:50:25.058-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2020-10-21T08:48:00.201-0400" prefix="">2020-10-21T08:48:00.201-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Storytelling Tool UI</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>In certain (as yet unidentified) circumstances, when removing a media block (audio, image, video), the block editor's singleFileUploader component is undefined by the time <a href="https://github.com/BlueSlug/sjrk-story-telling/blob/52e198dceae3e2aaa6a6e0334770cf9f25bdc6d5/src/ui/ui-storyEditor.js#L281-L304">sjrk.storyTelling.ui.storyEditor.removeSelectedBlocks()</a> is called.</p>
<p>This has only been observed in the tests for&#160;sjrk.storyTelling.ui.storyEditor and&#160;sjrk.storyTelling.base.page.storyEdit.</p>
<p></p>
<p><strong>To reproduce:</strong></p>
<ol>
<li>Check out the tool at this exact commit: <a href="https://github.com/BlueSlug/sjrk-story-telling/tree/52e198dceae3e2aaa6a6e0334770cf9f25bdc6d5">https://github.com/BlueSlug/sjrk-story-telling/tree/52e198dceae3e2aaa6a6e0334770cf9f25bdc6d5</a></li>
<li>Run the site via a basic HTTP server such as <a href="https://browsersync.io/">Browsersync</a></li>
<li>Navigate to the storyEditor browser tests: <a href="http://localhost:3000/tests/ui/html/ui-storyEditor-Tests.html">http://localhost:3000/tests/ui/html/ui-storyEditor-Tests.html</a></li>
</ol>
<p><strong>Expected:</strong></p>
<p>Tests complete successfully</p>
<p><strong>Actual:</strong></p>
<p>The tests hang and an error is displayed on the developer console (see attached screenshot):</p>
<pre><code class="hljs language-javascript">ui-storyEditor.<span class="hljs-property">js</span>:<span class="hljs-number">295</span> <span class="hljs-title class_">Uncaught</span> <span class="hljs-title class_">TypeError</span>: <span class="hljs-title class_">Cannot</span> read property <span class="hljs-string">'resetUploadState'</span> <span class="hljs-keyword">of</span> <span class="hljs-literal">undefined</span>
    at ui-storyEditor.<span class="hljs-property">js</span>:<span class="hljs-number">295</span>
    at <span class="hljs-title class_">Object</span>.<span class="hljs-property">fluid</span>.<span class="hljs-property">each</span> (infusion-all.<span class="hljs-property">js</span>:<span class="hljs-number">14543</span>)
    at sjrk.<span class="hljs-property">storyTelling</span>.<span class="hljs-property">ui</span>.<span class="hljs-property">storyEditor</span>.<span class="hljs-property">removeSelectedBlocks</span> (ui-storyEditor.<span class="hljs-property">js</span>:<span class="hljs-number">291</span>)
    at <span class="hljs-title function_">togo</span> (infusion-all.<span class="hljs-property">js</span>:<span class="hljs-number">21310</span>)
    at <span class="hljs-title class_">HTMLButtonElement</span>.<span class="hljs-property">fire</span> (infusion-all.<span class="hljs-property">js</span>:<span class="hljs-number">15643</span>)
    at <span class="hljs-title class_">HTMLButtonElement</span>.<span class="hljs-property">dispatch</span> (infusion-all.<span class="hljs-property">js</span>:<span class="hljs-number">5189</span>)
    at <span class="hljs-title class_">HTMLButtonElement</span>.<span class="hljs-property">elemData</span>.<span class="hljs-property">handle</span> (infusion-all.<span class="hljs-property">js</span>:<span class="hljs-number">4997</span>)
    at <span class="hljs-title class_">Object</span>.<span class="hljs-property">trigger</span> (infusion-all.<span class="hljs-property">js</span>:<span class="hljs-number">8255</span>)
    at <span class="hljs-title class_">HTMLButtonElement</span>.&lt;anonymous&gt; (infusion-all.<span class="hljs-property">js</span>:<span class="hljs-number">8333</span>)
    at <span class="hljs-title class_">Function</span>.<span class="hljs-property">each</span> (infusion-all.<span class="hljs-property">js</span>:<span class="hljs-number">360</span>)
</code></pre>

            </div>
            
            <div class="spacing-y-1">
                <h2>Environments</h2>
                <p>Infusion 3.0.0-dev.20200728T104627Z.e6aa1a341.<a href="/browse/FLUID-6145/">FLUID-6145</a></p>

            </div>
            
            
            
            <div class="spacing-y-1">
                <h2>Attachments</h2>
                <ul class="spacing-y-1" role="list">
                    
                    <li>
                        <a href="https://idrc.cachefly.net/issues.fluidproject.org/SJRK/SJRK-400/2020-10-20 ST tests hanging.PNG">
                            
                                <img src="https://idrc.cachefly.net/issues.fluidproject.org/SJRK/SJRK-400/2020-10-20 ST tests hanging.PNG" alt="2020-10-20 ST tests hanging.PNG">
                            
                        </a>
                    </li>
                    
                </ul>
            </div>
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-26587">
                        <p class="mb-0"><b>Gregor Moss</b> <i>commented <relative-time datetime="2020-10-20T20:59:27.611-0400">2020-10-20T20:59:27.611-0400</relative-time></i></p>
                        <p>From today's discussion in the #fluid-work IRC channel, a discussion between Justin Obara and Antranig Basman around why one aspect of one of of the attempted solutions did not work:</p>
<blockquote>
<p>&lt;Justin_o&gt; Bosmon: an unrelated questions. For the onDestroy event, is that fired before any destructive actions have taken place? With some updates to the storytelling tool that gmoss is working on. We were looking at firing a model change, to trigger an upstream model relay, just before the component is destroyed. I think there were some errors with a relay not being available though.<br>
&lt;Bosmon&gt; Yes, onDestroy is fired before anything is torn down<br>
&lt;Justin_o&gt; Bosmon: hmmm so the model relay should have worked then<br>
&lt;Justin_o&gt; which is what I was expecting. I guess we'll have to take a look at that error again<br>
&lt;Bosmon&gt; Justin_o - relays are not torn down until the last moment before afterDestroy<br>
&lt;Justin_o&gt; Bosmon: thanks for confirming that. might have been something else... will try to remember to check this with gmoss when he's online later</p>
</blockquote>

                    </li>
                    
                    <li id="comment-26588">
                        <p class="mb-0"><b>Justin Obara</b> <i>commented <relative-time datetime="2020-10-21T08:26:52.412-0400">2020-10-21T08:26:52.412-0400</relative-time></i></p>
                        <p>Gregor Moss&#160;and Antranig Basman&#160;I've pushed up a <a href="https://github.com/jobara/sjrk-story-telling/tree/SJRK-289-onDestroy">branch</a> that will include the issues with using onDestroy as mentioned in the comment above. See further discussion from the <a href="http://irc-logs.fluidproject.org/%23fluid-work/%23fluid-work.2020-10-21.log">fluid-work irc channel</a> today.</p>

                    </li>
                    
                    <li id="comment-26589">
                        <p class="mb-0"><b>Justin Obara</b> <i>commented <relative-time datetime="2020-10-21T08:48:00.201-0400">2020-10-21T08:48:00.201-0400</relative-time></i></p>
                        <p>There is an underlying framework issue that prevents using onDestroy as mentioned above. See:&#160;<a href="/browse/FLUID-6558/">FLUID-6558</a></p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/SJRK-399/"><span class="aria-hidden">←</span> Previous: SJRK-399</a>
        <a class="mx-1" href="/browse/SJRK-401/">Next: SJRK-401 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>