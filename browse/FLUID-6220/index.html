<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6220  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6220 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6220/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6220/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6220/">FLUID-6220</a></li>
            </ol>
        </nav>
        <h1>FLUID-6220: Automate testing of Infusion PRs</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6220">FLUID-6220</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Task">Task</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Fixed">Fixed</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Avtar Gill</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Avtar%20Gill">Avtar Gill</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2017-11-02T19:25:34.945-0400" prefix="">2017-11-02T19:25:34.945-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2024-07-22T10:35:04.895-0400" prefix="">2024-07-22T10:35:04.895-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Testing Infrastructure</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>It would be great if Infusion PRs could be tested by CI. GPII's CI automation (and automated PR testing) hasn't been replicated for Fluid due to Jenkins limitations, namely:</p>
<ul>
<li>An unmaintained Jenkins PR builder plugin</li>
<li>Buggy multijob plugin that doesn't honour timeout values</li>
<li>A vast world of pain that is Jenkins plugins management</li>
</ul>
<p>We've looked into GitLab CI which addresses the issues above and also provides nice features such as pipelines, simpler YAML job configuration files, pull-based CI agents, and a more pleasant UI. The main disadvantage with this option is that GitLab's CI offering is packaged as a larger offering meant to replace GitHub. They provide very limited GitHub repository mirroring which is triggered on an hourly basis. GitHub PRs can't be tested using just their software ‚Äì more information is logged in the <a href="https://issues.gpii.net/browse/GPII-2473">GPII-2473</a> issue.</p>
<p>Recently I came across <a href="https://buildkite.com/home#features">Buildkite</a>, a CI service that addresses all of the Jenkins and GitLab shortcomings. They provide&#160;<a href="https://buildkite.com/pricing">free accounts to open source projects</a> so I set up a <a href="https://buildkite.com/fluid-project">test Fluid organization</a>. You will need to create an account and be invited to the org to see CI results. Here is an example of an Infusion fork's PRs and branch merges being tested:</p>
<ul>
<li><a href="https://github.com/avtar/testingz/pull/1/commits">https://github.com/avtar/testingz/pull/1/commits</a></li>
<li><a href="https://github.com/avtar/testingz/commits/master">https://github.com/avtar/testingz/commits/master</a></li>
</ul>
<p>The config file used to test the above:</p>
<ul>
<li><a href="https://github.com/avtar/testingz/blob/master/.buildkite/pipeline.yml">https://github.com/avtar/testingz/blob/master/.buildkite/pipeline.yml</a></li>
</ul>
<p>The disadvantages of using Buildkite are:</p>
<ul>
<li>Proprietary service which can't be self-hosted ‚Äì although hosting Jenkins or GitLab involves considerable on-going maintenance costs in terms of securtity issues, testing new releases, support, etc.</li>
<li>Job failures and successes are shown in the GitHub UI but Buildkite accounts are required to view detailed CI results</li>
<li>I don't think PR jobs can be manually triggered using a confirmation string such as "ok to test" but I've contacted their support team to verify</li>
<li>They don't provide a contributor whitelist feature so anyone can open a PR, potentially containing malicious code, and trigger CI jobs</li>
</ul>
<p>There might be a workaround for the last point. When Michelle sent a test PR a </p>
<p><code>BUILDKITE_BUILD_CREATOR="michelled"</code> environment variable was available to the Buildkite agent. A list of trusted GitHub account names could be maintained and checked against before running any jobs on the agent.</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-22762">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2017-11-03T05:14:39.043-0400">2017-11-03T05:14:39.043-0400</relative-time></i></p>
                        <p>Thanks for continuing to look into alternatives, Avtar Gill.  I'd like to try out buildkite, can you please send an invite to tony@raisingthefloor.org?</p>

                    </li>
                    
                    <li id="comment-22765">
                        <p class="mb-0"><b>Avtar Gill</b> <i>commented <relative-time datetime="2017-11-03T09:28:19.094-0400">2017-11-03T09:28:19.094-0400</relative-time></i></p>
                        <p>Tony Atkins [RtF] I sent you an invitation. Please note that I was running the <a href="https://buildkite.com/docs/agent">Buildkite agent</a> on my laptop while testing.&#160;<a href="https://buildkite.com/docs/agent/osx">You'll need to run it</a> as well if you'd like to set up test builds ‚Äì the SSH key details can be ignored for now.</p>

                    </li>
                    
                    <li id="comment-22767">
                        <p class="mb-0"><b>Gregor Moss</b> <i>commented <relative-time datetime="2017-11-03T18:09:13.694-0400">2017-11-03T18:09:13.694-0400</relative-time></i></p>
                        <p>Thanks for putting this together, Avtar Gill! I'd like to check out the Buildkite site, can you invite <a href="mailto:mossmonkey@gmail.com">mossmonkey@gmail.com</a>&#160;please? üôÇ</p>
<p>I think the disadvantage of Buildkite being a proprietary service is worth noting, though it's a similar case to GitHub or Jira, which are both proprietary services with free-to-open-source tiers.</p>

                    </li>
                    
                    <li id="comment-22769">
                        <p class="mb-0"><b>Avtar Gill</b> <i>commented <relative-time datetime="2017-11-06T08:48:47.238-0500">2017-11-06T08:48:47.238-0500</relative-time></i></p>
                        <p>Gregor Moss, you should have an invitation now. Thanks for the help!</p>
<p>The GitHub comparison seems fair. I would add Slack to the list since more open source projects seem to be using their service. There's obviously the risk that some of these companies might change their free tier policies at some point in the future but it does let people kick the maintenance cost can down the road a bit.</p>

                    </li>
                    
                    <li id="comment-22771">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2017-11-07T05:35:18.162-0500">2017-11-07T05:35:18.162-0500</relative-time></i></p>
                        <p>Avtar Gill, any info on setup steps, such as the minimum permissions required when setting up your API Access Token?</p>

                    </li>
                    
                    <li id="comment-22774">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2017-11-07T05:39:33.410-0500">2017-11-07T05:39:33.410-0500</relative-time></i></p>
                        <p>nm, I see that the token is meant to be the organisation's agent access token.</p>

                    </li>
                    
                    <li id="comment-22776">
                        <p class="mb-0"><b>Avtar Gill</b> <i>commented <relative-time datetime="2017-11-07T16:44:40.122-0500">2017-11-07T16:44:40.122-0500</relative-time></i></p>
                        <p>Tony Atkins [RtF], there's now a Buildkite agent running in the IDRC data centre so you can avoid that part of the setup process. This is the repository that I've been testing with:</p>
<p><a href="https://github.com/fluid-bot/testingz">https://github.com/fluid-bot/testingz</a></p>
<p>If you send PRs there you should see CI statuses.</p>

                    </li>
                    
                    <li id="comment-22781">
                        <p class="mb-0"><b>Avtar Gill</b> <i>commented <relative-time datetime="2017-11-08T17:51:37.744-0500">2017-11-08T17:51:37.744-0500</relative-time></i></p>
                        <p>Hi all, I tried a couple workarounds in an attempt to prevent CI jobs from being run by unrecognized accounts. Unfortunately I didn't end up with an ideal solution. I tried using a <a href="https://buildkite.com/docs/agent/hooks">global environment hook</a> to check if the incoming changes were part of a pull request, check if a trusted user was making the changes, if not then pause the CI job. This didn't work because the environment hook is run before every command :/</p>
<p>The following change pauses all PR jobs:</p>
<p><a href="https://github.com/fluid-bot/testingz/commit/5e5bd8e69e12c0cabf65cc0cbb5f9b7a72c4ad46">https://github.com/fluid-bot/testingz/commit/5e5bd8e69e12c0cabf65cc0cbb5f9b7a72c4ad46</a></p>
<p>The jobs can be resumed by visiting the Buildkite dashboard and clicking <code>Unblock</code>. Not ideal by any means. I've filed an&#160;<a href="https://github.com/buildkite/feedback/issues/288">issue</a> requesting a behaviour similar to the defunct Jenkins PR builder plugin.</p>
<p></p>

                    </li>
                    
                    <li id="comment-22785">
                        <p class="mb-0"><b>Justin Obara</b> <i>commented <relative-time datetime="2017-11-09T08:39:58.937-0500">2017-11-09T08:39:58.937-0500</relative-time></i></p>
                        <p>Avtar Gill your feature request makes a lot of sense. In the meantime is there anything else we could do? I wonder if we have access to the <a href="https://developer.github.com/v3/activity/events/types/#pullrequestevent">pull request event</a> and if we can check for anything ourselves?</p>

                    </li>
                    
                    <li id="comment-22789">
                        <p class="mb-0"><b>Avtar Gill</b> <i>commented <relative-time datetime="2017-11-09T10:04:29.645-0500">2017-11-09T10:04:29.645-0500</relative-time></i></p>
                        <p>&gt; In the meantime is there anything else we could do?</p>
<p>I would add your +1s to that issue üòâ</p>
<p>&gt; I wonder if we have access to the <a href="https://developer.github.com/v3/activity/events/types/#pullrequestevent">pull request event</a> and if we can check for anything ourselves?</p>
<p>We could have a proxy service but it will start looking like <a href="/browse/GPII-2473/">GPII-2473</a> again, albeit this GitHub -&gt; Buildkite proxy would need to do less work than what's mentioned in the GPII issue. Two webhook URLs per repository would need to be configured ‚Äì the first one provided by Buildkite (for non-PR branches) and the second pointing to the proxy. The proxy would handle the GitHub account verification. If a recognized account was used to issue the PR then it would&#160;<a href="https://buildkite.com/docs/rest-api/builds#create-a-build">start a build</a> on the Buildkite side. If an unrecognized account was used then it would ask for confirmation using PR comments before starting a build. Seems clunky and brings us back to the scenario where we need to maintain this proxy and host additional infrastructure but so far&#160;<a href="https://github.com/blog/2463-github-welcomes-all-ci-tools">all the CI options on the table</a> seem to have their own clunky attributes.</p>

                    </li>
                    
                    <li id="comment-22793">
                        <p class="mb-0"><b>Avtar Gill</b> <i>commented <relative-time datetime="2017-11-13T15:55:09.844-0500">2017-11-13T15:55:09.844-0500</relative-time></i></p>
                        <p>I created a <a href="https://github.com/buildkite/feedback/issues/293">separate issue</a> requesting a feature that will allow for the blocking of unrecognized contributors' pull requests.</p>
<p>Here's a summary of what I tried last week. A <code>block step</code> for pull request branches will pause CI jobs. Buildkite fires <a href="https://buildkite.com/docs/webhooks">webhook events</a> whenever&#160;<a href="https://buildkite.com/docs/webhooks/build-events">builds</a> take place for any projects in an organization. One can <a href="https://buildkite.com/organizations/fluid-project/services/webhook/new">specify</a> to only have <code>build.finished</code> events fired. Then have the following handy:</p>
<ul>
<li>Buildkite API token with <code>read_builds</code> and <code>write_builds</code> privileges</li>
<li><code>fluid-bot</code> account name</li>
<li><code>fluid-bot's</code> email address</li>
</ul>
<p>Verify the incoming payload has the following properties:</p>
<ul>
<li>event: build.finished</li>
<li>build.blocked: true (due to the fact a block step was used for the PR branch)</li>
<li>build.url: &lt;whatever url is sent&gt;</li>
</ul>
<p>Make a <code>GET</code> request using the <code>build.url</code> value and obtain the job that has the <code>"state": "blocked"</code> and <code>"unblock_url"</code> properties. Issuing a request such as the following, using the <code>unblock_url</code> value, will resume the CI job:\</p>
<pre><code class="hljs language-java">curl -H <span class="hljs-string">"Authorization: Bearer &lt;buildkite api token&gt;"</span> \ 
-X PUT <span class="hljs-string">"https://api.buildkite.com/v2/organizations/fluid-project/pipelines/fluid-infusion-test/builds/18/jobs/f65f9669-3e46-49b9-9ef2-e736f3fbd051/unblock"</span> &#160;\
-d <span class="hljs-string">'{
    "fields": {
        "name": "fluid-bot",
        "email": "fluid-bot@looool.biz"
    } &#160; 
}‚Äô
</span></code></pre>
<p>It's still a workaround until Buildkite implements a feature that makes processing pull request CI jobs less risky but at leas the advantage of doing it this way for now is that the webhook only needs to be set up in one location, in the Buildkite organization's settings area.</p>
<p></p>

                    </li>
                    
                    <li id="comment-22798">
                        <p class="mb-0"><b>Avtar Gill</b> <i>commented <relative-time datetime="2017-12-04T16:03:17.057-0500">2017-12-04T16:03:17.057-0500</relative-time></i></p>
                        <p>Here's a workaround that tackles the above:</p>
<p><a href="https://github.com/avtar/unblock-buildkite-pr-job">https://github.com/avtar/unblock-buildkite-pr-job</a></p>

                    </li>
                    
                    <li id="comment-22800">
                        <p class="mb-0"><b>Colin Clark</b> <i>commented <relative-time datetime="2017-12-05T17:54:39.480-0500">2017-12-05T17:54:39.480-0500</relative-time></i></p>
                        <p>I merged the pull request at 3d20742aa38ce60cd9a0167960d1f4cad43841d8 and  have added the Github webhook for build kite. Anything else you need, Avtar Gill?</p>

                    </li>
                    
                    <li id="comment-22814">
                        <p class="mb-0"><b>Justin Obara</b> <i>commented <relative-time datetime="2017-12-06T11:12:08.906-0500">2017-12-06T11:12:08.906-0500</relative-time></i></p>
                        <p>For buildkite to report the build results, the fluid-bot needed to be given write access to the repository. This was done by creating a new "services" team with the correct permission and adding the fluid-bot to it.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6219/"><span class="aria-hidden">‚Üê</span> Previous: FLUID-6219</a>
        <a class="mx-1" href="/browse/FLUID-6221/">Next: FLUID-6221 <span class="aria-hidden">‚Üí</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>