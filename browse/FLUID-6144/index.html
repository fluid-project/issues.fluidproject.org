<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6144  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6144 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6144/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6144/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6144/">FLUID-6144</a></li>
            </ol>
        </nav>
        <h1>FLUID-6144: Bypass huge impact of Chrome deoptimisation of member deletion during scope cleanup</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6144">FLUID-6144</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Improvement">Improvement</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Open</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2017-03-10T22:11:33.533-0500" prefix="">2017-03-10T22:11:33.533-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2017-03-10T22:12:16.747-0500" prefix="">2017-03-10T22:12:16.747-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>2.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Framework</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>Beginning the work for <a href="/browse/FLUID-6143/">FLUID-6143</a>, inspecting the profile traces of the standard minimal instantiation performance test page at <a href="https://github.com/fluid-project/infusion/blob/master/tests/manual-tests/framework/core/performance-fastInvokers/js/performance-test.js#L125">https://github.com/fluid-project/infusion/blob/master/tests/manual-tests/framework/core/performance-fastInvokers/js/performance-test.js#L125</a> under Chrome showed a vast proportion of the cost (20-25%) of instantiation consumed by a single line - the scope cleanup in fluid.clearChildrenScope at <a href="https://github.com/fluid-project/infusion/blob/master/src/framework/core/js/FluidIoC.js#L937">https://github.com/fluid-project/infusion/blob/master/src/framework/core/js/FluidIoC.js#L937</a> - </p>
<pre><code class="hljs language-java">fluid.clearChildrenScope = function (instantiator, parentShadow, child, childShadow) {
        fluid.each(childShadow.contextHash, function (troo, context) {
            <span class="hljs-keyword">if</span> (parentShadow.childrenScope[context] === child) {
                delete parentShadow.childrenScope[context]; <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> ambiguous resolution</span>
            }
        });
    };
</code></pre>
<p>At first this was dismissed as a profiling artefact, but after some IRC discussion at <a href="https://botbot.me/freenode/fluid-work/2017-03-09/?msg=82164329">https://botbot.me/freenode/fluid-work/2017-03-09/?msg=82164329</a> we experimented with replacing the line with an assignment to <code>null</code> and found that the overall runtime performance amazingly did improve in line with the accounting in the profile trace. After some further thought, we considered that we could mostly likely performantly make this approach real, by shifting "tombstone cleanup" into fluid.resolveContext - <a href="https://botbot.me/freenode/fluid-work/2017-03-09/?msg=82166646&page=2">https://botbot.me/freenode/fluid-work/2017-03-09/?msg=82166646&amp;page=2</a> . Whilst this will be a pretty unstable optimisation, since the V8 team will doubtless be making constant adjustments to the details of their inline cache algorithm, the huge benefits on an important platform suggest that this may well be worth it for now. </p>
<p>Whilst there is some lore on <a href="https://github.com/petkaantonov/bluebird/wiki/Optimization-killers">https://github.com/petkaantonov/bluebird/wiki/Optimization-killers</a> suggesting that one should generally be suspicious of the <code>delete</code> operator, there is nothing to suggest the possibility for this incredible performance loss (on the order of 10s of microseconds per operation).</p>
<p>Interestingly this optimisation makes essentially no difference to the performance on Firefox, which in any case is about a clear factor of 4 slower than Chrome's in any case - doubtless because it is not making use of any sufficiently ingenious optimisations that could be defeated by this kind of operation.</p>

            </div>
            
            
            
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6143/"><span class="aria-hidden">←</span> Previous: FLUID-6143</a>
        <a class="mx-1" href="/browse/FLUID-6145/">Next: FLUID-6145 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>