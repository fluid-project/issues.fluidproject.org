<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6752  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6752 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6752/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6752/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6752/">FLUID-6752</a></li>
            </ol>
        </nav>
        <h1>FLUID-6752: Arguments to listeners are expanded eagerly, inconsistent with strategy for invoker arguments</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6752">FLUID-6752</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Open</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2022-10-14T09:57:37.676-0400" prefix="">2022-10-14T09:57:37.676-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2024-07-17T08:02:21.964-0400" prefix="">2024-07-17T08:02:21.964-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>4.4</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>6.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Framework</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>Arguments to listeners are expanded by a custom workflow leading from fluid.instantiateEvents -&gt; fluid.mergeListeners -&gt; fluid.event.resolveListenerRecord using the old-fashioned heavyweight "fluid.expandOptions"" rather than the more modern "fluid.preExpandOptions" seen in fluid.makeInvoker:</p>
<pre><code class="hljs language-java">fluid.event.resolveListenerRecord = function (lisrec, that, eventName, namespace, standard) {
....
    <span class="hljs-type">var</span> <span class="hljs-variable">transRecs</span> <span class="hljs-operator">=</span> fluid.transform(records, function (record) {
.... 
        <span class="hljs-type">var</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> expanded.listener = fluid.expandOptions(expanded.listener, that);
</code></pre>
<p>This implies that any volatile references, e.g. to model material will likely cause a workflow failure. We encountered this when writing a dataSource transforming event listener as</p>
<pre><code class="hljs language-java"><span class="hljs-string">"onRead.impl"</span>: {
            func: <span class="hljs-string">"hortis.sqliteSource.read"</span>,
            args: [<span class="hljs-string">"{that}.model.db"</span>, <span class="hljs-string">"{that}.options.readQuery"</span>, <span class="hljs-string">"{arguments}.0"</span>]
        },
</code></pre>
<p>which ended up forcing model evaluation far too early, as part of the pseudo-workflow stage 0 attached to "fluid.instantiateEvents" in the transitional framework.</p>
<p>What will this look like in the future? Probably not vastly different - we will still likely have some kind of monomorphisation site attached to these resolution sites, only we will at least have somewhere sensible to cache their results as part of the immutable tree. There will still be "workflow stages" only these will be scheduled as ticks rather than as promise tangles.</p>
<p>Analogous issues are <a href="/browse/FLUID-6373/">FLUID-6373</a>, noting that the "func" member of listeners/invokers is always evaluated early, and <a href="/browse/FLUID-6405/">FLUID-6405</a> noting that the evaluation of "listener" members of IoC testing framework blocks is always eager.</p>

            </div>
            
            
            
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6751/"><span class="aria-hidden">←</span> Previous: FLUID-6751</a>
        <a class="mx-1" href="/browse/FLUID-6753/">Next: FLUID-6753 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>