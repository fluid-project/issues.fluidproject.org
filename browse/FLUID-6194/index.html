<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6194  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6194 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6194/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6194/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6194/">FLUID-6194</a></li>
            </ol>
        </nav>
        <h1>FLUID-6194: Model relay will relay deletes even if transform is not invertible</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6194">FLUID-6194</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Fixed">Fixed</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2017-09-15T15:51:23.907-0400" prefix="">2017-09-15T15:51:23.907-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2017-09-28T11:39:13.979-0400" prefix="">2017-09-28T11:39:13.979-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>2.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>3.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Data Binder</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>The <a href="/browse/FLUID-5585/">FLUID-5585</a> behaviour for relaying deletes through relays has been incorrectly implemented. In the case where the transform has no inverse, or the relay rule should otherwise not operate backwards, the deletion clearing will nonetheless be relayed back through the rule, trashing the model at the other end.</p>
<p>The PCP channel work for <a href="/browse/GPII-2556/">GPII-2556</a> in <a href="https://github.com/GPII/universal/pull/549">https://github.com/GPII/universal/pull/549</a> included the following rule:</p>
<pre><code class="hljs language-java"><span class="hljs-comment">// A mixin grade applied to the lifecycleManager's session by the pcpChannel</span>
fluid.defaults(<span class="hljs-string">"gpii.flowManager.pcpChannel.sessionBinder"</span>, {
    modelRelay: {
        pcpChannel: {
            source: { <span class="hljs-comment">// Not "" because of <a href="/browse/FLUID-6192/">FLUID-6192</a></span>
                segs: []
            },
            target: <span class="hljs-string">"{flowManager}.pcpChannel.model"</span>,
            singleTransform: {
                type: <span class="hljs-string">"gpii.flowManager.pcpChannel.sessionToPCP"</span>,
                ontologyMetadata: <span class="hljs-string">"{ontologyHandler}.ontologyMetadata"</span>
            }
        }
    },
</code></pre>
<p>No inverse is written for the <code>sessionToPCP</code> function so the relay should not operate backwards. However, when a DELETE is triggered at the PCP's end via</p>
<pre><code class="hljs language-java">gpii.flowManager.pcpChannel.sessionStop = function (pcpChannel) {
    pcpChannel.applier.change(<span class="hljs-string">""</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"DELETE"</span>);
};
</code></pre>
<p>the following code in DataBinding.js is triggered:</p>
<pre><code class="hljs language-java"><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This rather crummy function is the only site with a hard use of "path" as String</span>
    fluid.transformToAdapter = function (transform, targetPath) {
        <span class="hljs-type">var</span> <span class="hljs-variable">basedTransform</span> <span class="hljs-operator">=</span> {};
        basedTransform[targetPath] = transform; <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Faulty with respect to escaping rules</span>
        <span class="hljs-keyword">return</span> function (trans, newValue, sourceSegs, targetSegs, changeRequest) {
            <span class="hljs-keyword">if</span> (changeRequest &amp;&amp; changeRequest.type === <span class="hljs-string">"DELETE"</span>) {
                trans.fireChangeRequest({type: <span class="hljs-string">"DELETE"</span>, path: targetPath}); <span class="hljs-comment">// avoid mouse droppings in target document for <a href="/browse/FLUID-5585/">FLUID-5585</a></span>
            }
            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> More efficient model that can only run invalidated portion of transform (need to access changeMap of source transaction)</span>
            fluid.model.transformWithRules(newValue, basedTransform, {finalApplier: trans});
        };
    };
</code></pre>
<p>This exposes the fact that the generation of the "backward" adaptor is pretty clumsy in its ability to determine when a rule is invertible. It accepts any old rubbish from fluid.model.transform.invertConfiguration which doesn't usefully signal whether it has inverted anything or not.</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">if</span> (sourcePath !== <span class="hljs-literal">null</span>) {
                that.backwardHolder.model = fluid.model.transform.invertConfiguration(transform);
                that.backwardAdapterImpl = fluid.transformToAdapter(that.backwardHolder.model, sourcePath);
            }
</code></pre>
<p>The reliance on "sourcePath" is a bit peculiar. Presumably this excludes "self-sufficient" transforms which source all material from within the transform from being inverted.</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-24011">
                        <p class="mb-0"><b>Cindy Li</b> <i>commented <relative-time datetime="2017-09-28T11:39:09.797-0400">2017-09-28T11:39:09.797-0400</relative-time></i></p>
                        <p><a href="https://github.com/fluid-project/infusion/pull/851">The pull request</a> has been merged into the project repo master branch at 5dd8f82d9237174336c23e9c88c09fdebeab3003</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6193/"><span class="aria-hidden">←</span> Previous: FLUID-6193</a>
        <a class="mx-1" href="/browse/FLUID-6195/">Next: FLUID-6195 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>