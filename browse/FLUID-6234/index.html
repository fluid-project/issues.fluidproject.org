<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6234  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6234 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6234/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6234/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6234/">FLUID-6234</a></li>
            </ol>
        </nav>
        <h1>FLUID-6234: Sorting of application of model values init transaction does not respect relay propagation directives</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6234">FLUID-6234</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Fixed">Fixed</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2017-12-16T13:22:33.992-0500" prefix="">2017-12-16T13:22:33.992-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2024-07-22T10:35:16.928-0400" prefix="">2024-07-22T10:35:16.928-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Data Binder</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>Even if the user attempts to express a preference for which components should have their initial model values take priority during the "init transaction" by using directives such as</p>
<pre><code class="hljs language-java">forward: { excludeSource: <span class="hljs-string">"init"</span>}
</code></pre>
<p>, the framework may sort the application times of these initial values into an ordering which leads to a final set of resolved values around the model skeleton that does not respect this preference.</p>
<p>For example, this test environment taken from a branch of @colin 's Aconite project at <a href="https://github.com/colinbdclark/aconite/blob/gh-9/tests/unit/video-performer-tests.js#L19">https://github.com/colinbdclark/aconite/blob/gh-9/tests/unit/video-performer-tests.js#L19</a>&#160;specifies an initial value for a component which participates in a relay with two subcomponents:</p>
<pre><code class="hljs language-javascript">fluid.<span class="hljs-title function_">defaults</span>(<span class="hljs-string">"aconite.test.videoPerformer.testEnvironment"</span>, {
        <span class="hljs-attr">gradeNames</span>: <span class="hljs-string">"fluid.test.testEnvironment"</span>,

        <span class="hljs-attr">components</span>: {
            <span class="hljs-attr">videoPerformer</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">"aconite.videoPerformer"</span>,
                <span class="hljs-attr">options</span>: {
                    <span class="hljs-attr">model</span>: {
                        <span class="hljs-attr">loop</span>: <span class="hljs-literal">true</span>
                    }
                }
            }
</code></pre>
<p>The subcomponents have been each set up in <a href="https://github.com/colinbdclark/aconite/blob/gh-9/src/video-performer.js">https://github.com/colinbdclark/aconite/blob/gh-9/src/video-performer.js</a> with a relay directive as follows which should prevent child values from propagating up to the parent:</p>
<pre><code class="hljs language-javascript">fluid.<span class="hljs-title function_">defaults</span>(<span class="hljs-string">"aconite.videoPerformer.relayingChild"</span>, {
        <span class="hljs-attr">gradeNames</span>: <span class="hljs-string">"fluid.modelComponent"</span>,

        <span class="hljs-attr">model</span>: {},

        <span class="hljs-comment">// Note: this relay is required to prevent</span>
        <span class="hljs-comment">// initial model values from propagating back</span>
        <span class="hljs-comment">// from this component up to the parent,</span>
        <span class="hljs-comment">// overriding the user's desired value.</span>
        <span class="hljs-attr">modelRelay</span>: {
            <span class="hljs-attr">source</span>: <span class="hljs-string">"{videoPerformer}.model"</span>,
            <span class="hljs-attr">target</span>: <span class="hljs-string">"{that}.model"</span>,
            <span class="hljs-attr">backward</span>: {
                <span class="hljs-attr">excludeSource</span>: <span class="hljs-string">"init"</span>
            },
            <span class="hljs-attr">singleTransform</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">"fluid.transforms.identity"</span>
            }
        }
    });
</code></pre>
<p>The definition does indeed stop the propagation of the child values during the init transaction, but the final resolved value across the skeleton is not the one that the user desires - during the process of resolving the init transaction, the parent's value is applied first and the children's later, leading the children to have the default value of <code>loop: false</code> and only the parent with the inconsistent, desired value of <code>loop: true</code>.</p>
<p>It is finally time to bite the bullet and introduce a topological sorting algorithm that guarantees to respect such one-way directives during the init transaction - that is, the directed graph induced by such directives needs to be parsed out of the total configuration and used to induce a topological sorting order which applies "most depended-on values" last.</p>

            </div>
            
            
            
            <div class="spacing-y-1">
                <h2>Attachments</h2>
                <ul class="spacing-y-1" role="list">
                    
                    <li>
                        <a href="https://idrc.cachefly.net/issues.fluidproject.org/FLUID/FLUID-6234/aconite-init-failure.png">
                            
                                <img src="https://idrc.cachefly.net/issues.fluidproject.org/FLUID/FLUID-6234/aconite-init-failure.png" alt="aconite-init-failure.png">
                            
                        </a>
                    </li>
                    
                </ul>
            </div>
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-18798">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2017-12-16T13:25:58.144-0500">2017-12-16T13:25:58.144-0500</relative-time></i></p>
                        <p>It appears that the crucial element tipping the framework into the incorrect sorting is the nested default value supplied from the test environment, since the gist at <a href="https://gist.github.com/colinbdclark/5b92588349bb1430fa74853256e72757">https://gist.github.com/colinbdclark/5b92588349bb1430fa74853256e72757</a>&#160;attempting to isolate the problem doesn't exhibit it.</p>

                    </li>
                    
                    <li id="comment-18801">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2017-12-16T13:29:37.885-0500">2017-12-16T13:29:37.885-0500</relative-time></i></p>
                        <p>It's been known for a while that this was an area in which the framework's behaviour was underdetermined and underimplemented - see comment at <a href="https://github.com/fluid-project/infusion/blob/5dd8f82d9237174336c23e9c88c09fdebeab3003/src/framework/core/js/DataBinding.js#L346">https://github.com/fluid-project/infusion/blob/5dd8f82d9237174336c23e9c88c09fdebeab3003/src/framework/core/js/DataBinding.js#L346</a></p>

                    </li>
                    
                    <li id="comment-18805">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2017-12-16T13:38:49.785-0500">2017-12-16T13:38:49.785-0500</relative-time></i></p>
                        <p>Useful screenshot showing incoming model values during the init transaction. Note that since none of the instantiating components have been marked as "completeOnInit" since they are all currently in construction, the sort done on the previous line has no stable effect, whereas we need to arrange to sort the the record for the "aconite.video" component to the last position. </p>
<!-- media: file fbc86116-5464-4a14-8057-8798a670a86a -->

                    </li>
                    
                    <li id="comment-18808">
                        <p class="mb-0"><b>Colin Clark</b> <i>commented <relative-time datetime="2018-01-22T12:15:18.811-0500">2018-01-22T12:15:18.811-0500</relative-time></i></p>
                        <p>I reviewed and merged this fix at 350441a9bd6dfc8fbb8a1753bfbb8fadd6c2dcc9, and published a dev release, version 3.0.0-dev.20180122T170655Z.350441a9b, to npm.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6233/"><span class="aria-hidden">←</span> Previous: FLUID-6233</a>
        <a class="mx-1" href="/browse/FLUID-6235/">Next: FLUID-6235 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>