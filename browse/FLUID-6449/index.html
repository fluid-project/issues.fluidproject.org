<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6449  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6449 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6449/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6449/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6449/">FLUID-6449</a></li>
            </ol>
        </nav>
        <h1>FLUID-6449: fluid.dataSource.URL doesn't work with termMap</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6449">FLUID-6449</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Task">Task</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Open</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>N/A</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Gregor%20Moss">Gregor Moss</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2020-01-16T15:12:10.500-0500" prefix="">2020-01-16T15:12:10.500-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2020-01-21T08:18:23.963-0500" prefix="">2020-01-21T08:18:23.963-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Framework</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <h1>The issue</h1>
<p>The current version of fluid.dataSource.URL, which at time of filing is "freshly" extracted from kettle.dataSource.URL and exists only dev branches, does not seem to work properly when the termMap option is specified on the grade.</p>
<p>The reason for this seems to be down to this line in code: <a href="https://github.com/amb26/infusion/blob/2e487c617e8f57a067a37b9d6aed82fb7a26d87a/src/framework/core/js/DataSource.js#L295">https://github.com/amb26/infusion/blob/2e487c617e8f57a067a37b9d6aed82fb7a26d87a/src/framework/core/js/DataSource.js#L295</a></p>
<pre><code class="hljs language-javascript">requestOptions.<span class="hljs-property">path</span> = (resolveUrl || fluid.<span class="hljs-property">dataSource</span>.<span class="hljs-property">URL</span>.<span class="hljs-property">resolveUrl</span>)(requestOptions.<span class="hljs-property">path</span>, requestOptions.<span class="hljs-property">termMap</span>, directModel);
</code></pre>
<p></p>
<p>The issue is that it seems that it is not possible for the "path" value on requestOptions to be anything other than "undefined" at this point in execution, and if termMap is specified then the call to fluid.dataSource.URL.resolveUrl will result in a call to fluid.stringTemplate that will generate an error and bring execution to a halt.</p>
<p>I have found that adjusting the argument passed into resolveUrl to be "requestOptions.url" seems to produce the expected behaviour, but it would be good to get Antranig Basman's confirmation that this is semantically valid.</p>
<p>Detailed tests should also be added to validate the expected behaviour, whatever it ends up being.</p>
<hr>
<h1>Further detail and context</h1>
<p>I have created a branch that&#160;includes the fix I propose above:<br>
<a href="https://github.com/BlueSlug/infusion/tree/NOJIRA-broken-dataSource-URL">https://github.com/BlueSlug/infusion/tree/NOJIRA-broken-dataSource-URL</a></p>
<p>Additionally, it seems that the work was filed under <a href="/browse/FLUID-4982/">FLUID-4982</a>:<br>
<a href="https://github.com/amb26/infusion/commit/f42dd15e00aacaaab821fe853204a66d7609a59d">https://github.com/amb26/infusion/commit/f42dd15e00aacaaab821fe853204a66d7609a59d</a></p>
<p>There is also an existing Jira that seems to cover the work expressed in the commit above. I'm not sure if it's the same but I'm linking it here just in case:<br>
<a href="https://issues.fluidproject.org/browse/KETTLE-61">https://issues.fluidproject.org/browse/KETTLE-61</a></p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-25271">
                        <p class="mb-0"><b>Justin Obara</b> <i>commented <relative-time datetime="2020-01-17T07:26:06.297-0500">2020-01-17T07:26:06.297-0500</relative-time></i></p>
                        <p>While not the specific cause of the issue, something that also caused confusion when trying to track things down is the fact that fluid.stringTemplate will return back whatever is passed in as the template if there are no values provided. However, if the template isn't a string and keys are provided, it will throw an error.</p>
<p><a href="https://github.com/fluid-project/infusion/blob/master/src/framework/core/js/Fluid.js#L2979-L2993">https://github.com/fluid-project/infusion/blob/master/src/framework/core/js/Fluid.js#L2979-L2993</a></p>

                    </li>
                    
                    <li id="comment-25272">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2020-01-21T08:18:23.963-0500">2020-01-21T08:18:23.963-0500</relative-time></i></p>
                        <p>Well spotted on finding this flaw, but the supplied fix isn't right - the reason for this drift is the discrepancy between the "old URL API" on node, which parsed the URL into a field "path" ~~&#160;<s><s><a href="https://nodejs.org/api/url.html#url_urlobject_path">https://nodejs.org/api/url.html#url_urlobject_path</a></s></s>&#160;~~ and the new whatwg API (available both in modern browsers and node) which looks like it now uses a field "pathname" -&#160;<a href="https://url.spec.whatwg.org/#url-class">https://url.spec.whatwg.org/#url-class</a>&#160;. We can't mix up "url" which is a field representing the overall url and the parsed-out fields such as "path". Note that it looks like there is an additional confusion, however, in that the file-backed DataSource looks like it exploits the coincidence of its top-level field "path" with the old-fashioned parsed URL field "path" in order to get term expansion done.</p>
<p>In general this hoisting of DataSource into the browser is pretty incomplete work and its good that issues like this are highlighting it. In practice this isn't ready to go in until we can similarly port the test cases from Kettle into Infusion such as&#160;<a href="https://github.com/fluid-project/kettle/blob/master/tests/DataSourceURLTests.js">https://github.com/fluid-project/kettle/blob/master/tests/DataSourceURLTests.js</a>&#160;. This will need some thought since we can't easily support these without some ability to run an HTTP server within the test cases, which implies significantly increasing their dependency footprint. I imagine this will require one of the gpii-testem configurations developed by Tony Atkins [RtF].</p>
<p>Note that in Kettle there are some pretty comprehensive tests for many aspects of the DataSource API including term expansion but they are currently only targetted at the file-backed DataSource ~~&#160;<s><s><a href="https://github.com/fluid-project/kettle/blob/master/tests/DataSourceFileTests.js">https://github.com/fluid-project/kettle/blob/master/tests/DataSourceFileTests.js</a></s></s>&#160;~~ we need to generalise these so that they run against the URLDataSource too.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6448/"><span class="aria-hidden">←</span> Previous: FLUID-6448</a>
        <a class="mx-1" href="/browse/FLUID-6450/">Next: FLUID-6450 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>