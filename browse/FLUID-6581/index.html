<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6581  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6581 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6581/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6581/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6581/">FLUID-6581</a></li>
            </ol>
        </nav>
        <h1>FLUID-6581: Implement "poor man's immutability" as stopgap for storing large resources in models</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6581">FLUID-6581</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Improvement">Improvement</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Reopened</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2020-11-23T08:34:41.075-0500" prefix="">2020-11-23T08:34:41.075-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2024-07-17T08:13:42.149-0400" prefix="">2024-07-17T08:13:42.149-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Framework</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>As explained on the old <a href="https://wiki.fluidproject.org/display/fluid/New+Notes+on+the+ChangeApplier">https://wiki.fluidproject.org/display/fluid/New+Notes+on+the+ChangeApplier</a> (now more than 6 years old) there was an intention to implement "thin models" which didn't get copied on every transaction. Since then our thinking has moved on a lot and the preferred solution to such problems is a combination of the <a href="/browse/FLUID-6396/">FLUID-6396</a> "immutable application model" possibly combined with a lightweight immutable array class such as the one in Facebook's "immutable.js" at <a href="https://github.com/immutable-js/immutable-js/blob/master/src/List.js">https://github.com/immutable-js/immutable-js/blob/master/src/List.js</a> (now seemingly lightly maintained - is this a case of "it is already perfect so no updates required" or the more usual case of a loss of interest and focus). Note - algorithm behind such a container is illustrated at <a href="https://hypirion.com/musings/understanding-persistent-vector-pt-1">https://hypirion.com/musings/understanding-persistent-vector-pt-1</a></p>
<p>It has simply become too annoying not to be able to store resources in models (current work - Covid map viz at <a href="https://github.com/amb26/fluid-covid-map-viz/tree/FLUID-6540">https://github.com/amb26/fluid-covid-map-viz/tree/FLUID-6540</a> ) and we need some kind of stop-gap solution before we can afford the wholesale revolution of implementing the entire ChangeApplier machinery (and indeed wider framework) in terms of <a href="/browse/FLUID-6396/">FLUID-6396</a> immutable structures.</p>
<p>A quick hack seems to be to apply the same trick that we used to subvert the framework's options merging pipeline by creating "identifiable arrays" that would not get multiply reduced - e.g.</p>
<pre><code class="hljs language-java">fluid.mergingArray = function () {};
    fluid.mergingArray.prototype = [];
</code></pre>
<p>We will create two such fake containers for [] and [], which will pass the fluid.isUncopyable check but hopefully be indistinguishable to all other use. Any resource which gets resolved into a model will convert its base container into one of these kinds before storage.</p>
<p>The bad side effect of this is that changes addressed to the inside of this model region become impossible - the "bad kind" of immutability! Since the entire region becomes aliased in the transaction, our check for null transactions before notification concludes that no change has happened:</p>
<pre><code class="hljs language-java">fluid.notifyModelChanges = function (....
...
        <span class="hljs-keyword">if</span> (!spec.isRelay) {
        <span class="hljs-type">var</span> <span class="hljs-variable">isNull</span> <span class="hljs-operator">=</span> fluid.model.diff(args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">if</span> (isNull) {
            <span class="hljs-keyword">continue</span>;
        }
</code></pre>
<p>However, this check is pretty isolated and we may be able to produce a simple means of defeating it by spotting such containers along the invalidPath. This aligns with some of the ancient thinking in the wiki document which noted that our path invalidation scheme is somewhat belt-and-braces with respect to our use of diff at the notification point.</p>
<p>In the meantime we will create this as an "opt-in" scheme since the observable effects will be pretty awkward and should be invited with awareness of the tradeoffs. </p>
<p>Note that the newest kind of <a href="/browse/FLUID-6580/">FLUID-6580</a> integration constant lenses will not work on such material since they rely on the ability to resolve old model values. So far the use cases for such things seem distinct, but this further creates pressure on moving to the immutable model.</p>

            </div>
            
            
            
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6580/"><span class="aria-hidden">←</span> Previous: FLUID-6580</a>
        <a class="mx-1" href="/browse/FLUID-6582/">Next: FLUID-6582 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>