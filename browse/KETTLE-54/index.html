<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> KETTLE-54  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" KETTLE-54 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/KETTLE-54/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/KETTLE-54/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/KETTLE" data-pagefind-filter="project">Kettle</a></li>
                <li><a href="/browse/KETTLE-54/">KETTLE-54</a></li>
            </ol>
        </nav>
        <h1>KETTLE-54: Cannot distinguish errors from successes using only onWrite and onError listeners...</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/KETTLE-54">KETTLE-54</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/KETTLE/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Open</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/KETTLE/?reporter=Tony%20Atkins%20%5BRtF%5D">Tony Atkins [RtF]</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2017-01-05T04:09:29.944-0500" prefix="">2017-01-05T04:09:29.944-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2017-01-09T10:03:42.514-0500" prefix="">2017-01-09T10:03:42.514-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>In troubleshooting <a href="/browse/KETTLE-53/">KETTLE-53</a>, part of the problem was that the network error was obscured because of the order in which events are fired.  What happens is that, when an error occurs:</p>
<ol>
<li>The remaining onWrite event listeners are called <strong>with the original payload</strong>.</li>
<li>The onError listener is called</li>
</ol>
<p>As far as I can see, this combination of behaviors makes it unsafe to rely solely on onError and onWrite listeners, as you cannot tell that an error has occurred before you receive what might either be the receipt from a successful write or simply the original unaltered payload.</p>
<p>The workaround for the time being is to only use {kettle.dataSource.URL.writable}.set in its promise form.  The problem and the workaround are demonstrated here:</p>
<pre><code class="hljs language-java"><span class="hljs-string">"use strict"</span>;
<span class="hljs-type">var</span> <span class="hljs-variable">fluid</span> <span class="hljs-operator">=</span> require(<span class="hljs-string">"infusion"</span>);
fluid.setLogging(<span class="hljs-literal">true</span>);

function <span class="hljs-title function_">logPromiseSuccess</span> <span class="hljs-params">()</span> {
    fluid.log(<span class="hljs-string">"promise success..."</span>)
}

function <span class="hljs-title function_">logPromiseFailure</span> <span class="hljs-params">()</span> {
    fluid.log(<span class="hljs-string">"promise failure..."</span>)
}

<span class="hljs-type">var</span> <span class="hljs-variable">kettle</span> <span class="hljs-operator">=</span> require(<span class="hljs-string">"kettle"</span>);
<span class="hljs-type">var</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> kettle.dataSource.URL({
    gradeNames: [<span class="hljs-string">"kettle.dataSource.URL.writable"</span>],
    writeMethod: <span class="hljs-string">"PUT"</span>,
    url: <span class="hljs-string">"http://localhost:9999/"</span>,
    listeners: {
        <span class="hljs-string">"onWrite.log"</span>: {
            priority: <span class="hljs-string">"last"</span>,
            funcName: <span class="hljs-string">"fluid.log"</span>,
            args: [<span class="hljs-string">"onWrite event with payload:\n"</span>, <span class="hljs-string">"@expand:JSON.stringify({arguments}, null, 2)"</span>]
        },
        <span class="hljs-string">"onError.log"</span>: {
            priority: <span class="hljs-string">"last"</span>,
            funcName: <span class="hljs-string">"fluid.log"</span>,
            args: [<span class="hljs-string">"onError event..."</span>]
        }
    }
});

<span class="hljs-type">var</span> <span class="hljs-variable">promise</span> <span class="hljs-operator">=</span> dataSource.set({}, { payload: <span class="hljs-string">"data"</span>});
promise.then(logPromiseSuccess, logPromiseFailure);
</code></pre>
<p>Here is sample output:</p>
<pre><code class="hljs language-java"><span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">53.952</span>:  onWrite event with payload:
{
  <span class="hljs-string">"payload"</span>: <span class="hljs-string">"data"</span>
}
<span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">53.954</span>:  DataSource Issuing HTTP request with options {
    <span class="hljs-string">"port"</span>: <span class="hljs-string">"9999"</span>,
    <span class="hljs-string">"method"</span>: <span class="hljs-string">"PUT"</span>,
    <span class="hljs-string">"headers"</span>: {
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
        <span class="hljs-string">"Content-Length"</span>: <span class="hljs-number">0</span>
    },
    <span class="hljs-string">"protocol"</span>: <span class="hljs-string">"http:"</span>,
    <span class="hljs-string">"auth"</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-string">"host"</span>: <span class="hljs-string">"localhost:9999"</span>,
    <span class="hljs-string">"hostname"</span>: <span class="hljs-string">"localhost"</span>,
    <span class="hljs-string">"path"</span>: <span class="hljs-string">"/"</span>,
    <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:9999/"</span>,
    <span class="hljs-string">"termMap"</span>: {
        
    },
    <span class="hljs-string">"directModel"</span>: {
        
    },
    <span class="hljs-string">"operation"</span>: <span class="hljs-string">"set"</span>,
    <span class="hljs-string">"reverse"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"writeMethod"</span>: <span class="hljs-string">"PUT"</span>
}
<span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">53.964</span>:  onError event...
<span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">53.964</span>:  promise failure...
</code></pre>
<p>Note that the onWrite, which should receive the results of a successful write, is instead receiving the original payload.  Since onWrite is fired first, there is no way to cleanly decide whether to send a receipt or an error message.  Note also that the promise rejection handler is fired, but not the promise success handler.</p>
<p>I would expect one of two things to happen when an error is encountered:</p>
<ol>
<li>onError is fired and no remaining onWrite events are fired.</li>
<li>onError is fired, and then the remaining onWrite events are fired.  This would allow for retries, but also for clear "stop the world" type error processing by setting a "dirty" member to indicate that a failure has already occurred.</li>
</ol>
<p>cc: Antranig Basman</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-26141">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2017-01-09T10:03:42.514-0500">2017-01-09T10:03:42.514-0500</relative-time></i></p>
                        <p>You are correct that the current implementation is faulty, but we need to elaborate exactly how, since neither of the two expectations (1. and 2. in your issue) correspond to the fix we should have. Recall from the docs that onWrite is not a standard event but a pseudoevent - <a href="https://github.com/fluid-project/kettle/blob/master/docs/DataSources.md#transforming-promise-chains">https://github.com/fluid-project/kettle/blob/master/docs/DataSources.md#transforming-promise-chains</a> - meaning that they form the actual implementation of the dataSource data pipeline, and are not merely notifications fired from various stages of it. The other crucial upshot of this is that the <strong>return values</strong> from each of these listeners is crucial - by returning nothing from onWrite.log you've actually completely destroyed the payload which would have been sent to the network - in this case this isn't so relevant since the network activity has been set up to fail.</p>
<p>I think you have the ordering of activities the wrong way round - it is not that "when an error occurs, the remaining onWrite listeners are notified with the original payload". As the implementation is structured, ALL onWrite listeners are notified, in the order corresponding to their payloads, and then the actual network activity occurs as a result of dataSource.setImpl. So your log notification actually precedes the error, not the other way round.</p>
<p>You're completely correct that the current implementation does not provide any decent means to provide processing "which only occurs in the event of a successful write" (or read). The answer to this is to fix the factoring of dataSource which has been pending for a while. It has inherited a rather screwed-up and asymmetric design based around hard-wired invokers named getImpl and setImpl. Instead these should be folded into the main request processing pipeline as standard listeners to onRead and onWrite, as described in <a href="/browse/KETTLE-55/">KETTLE-55</a>. It would then be possible to attach listeners to the namespace, e.g. "after:backing" which would then only execute in the case of a successful network write.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/KETTLE-53/"><span class="aria-hidden">←</span> Previous: KETTLE-53</a>
        <a class="mx-1" href="/browse/KETTLE-55/">Next: KETTLE-55 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>