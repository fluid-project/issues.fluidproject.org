<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6445  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6445 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6445/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6445/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6445/">FLUID-6445</a></li>
            </ol>
        </nav>
        <h1>FLUID-6445: fluid.promise.fireTransformEvent does not participate in event cancellation</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6445">FLUID-6445</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Fixed">Fixed</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2019-12-19T18:19:03.721-0500" prefix="">2019-12-19T18:19:03.721-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2024-07-22T10:35:22.996-0400" prefix="">2024-07-22T10:35:22.996-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Framework</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>The "pseudo-event" system operated by fluid.promise.fireTransformEvent, given how it sits uneasily in the penumbra between a properly integrated framework facility and an opportunistic addon, hasn't been properly integrated into the event/invoker cancellation system described in <a href="/browse/FLUID-5333/">FLUID-5333</a> and <a href="/browse/FLUID-5790/">FLUID-5790</a>.</p>
<p>This was responsible for the CI failure seen at&#160;<a href="https://github.com/GPII/universal/pull/833">https://github.com/GPII/universal/pull/833</a>&#160;. In Tony Atkins [RtF] 's implementation of gpii-couchdb-test-harness, there is a "dockerWorker" which participates in the pseudoevent system with an event "combinedStartup". In this case, one of the listeners to startup actually synchronously triggers the destruction of the entire harness via a synchronous call to gpii.stop() in the test fixture -&#160;<a href="https://github.com/GPII/universal/blob/master/tests/StartupAPITests.js#L48">https://github.com/GPII/universal/blob/master/tests/StartupAPITests.js#L48</a></p>
<p>Unfortunately the framework then continues to service further listeners (we should determine in detail what has happened here since there are a few anomalies - presumably gpii.stop should not actually destroy the harness, and it is not clear what listener is actually in progress when the failed resolution occurs), which triggers a failure within fluid.resolveContext in the unguarded code in this fast path branch:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">if</span> (fast) {
                <span class="hljs-type">var</span> <span class="hljs-variable">shadow</span> <span class="hljs-operator">=</span> instantiator.idToShadow[that.id];
                <span class="hljs-keyword">return</span> shadow.ownScope[context];
            } <span class="hljs-keyword">else</span> {
</code></pre>
<p>We should adjust fluid.promise.fireTransformEvent so that it forwards the discovery of the cancellation of the base event into cancellation of the promise sequence, which interestingly was just implemented this evening in order to fix an intermittent race in the relocalisation code for <a href="/browse/FLUID-6442/">FLUID-6442</a>.</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-25289">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2019-12-19T18:21:50.824-0500">2019-12-19T18:21:50.824-0500</relative-time></i></p>
                        <p>As well as, of course, guarding the actual access site in fluid.resolveContext with a suitable comment.</p>

                    </li>
                    
                    <li id="comment-25290">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2019-12-19T19:49:56.580-0500">2019-12-19T19:49:56.580-0500</relative-time></i></p>
                        <p>The situation in <a href="https://github.com/GPII/universal/pull/833">https://github.com/GPII/universal/pull/833</a>&#160;with StartupAPITests.js is much simpler than expected. The harness is destroyed because it is a subcomponent of the "config", and there are no extra sequence elements beyond what can be seen in the test cases. In particular, the test fixture makes no attempt to wait for the GPII to actually complete starting up or wait for any of the elements of the "combinedStartup" promise chain in the harness before it unceremoniously and synchronously destroys it all. So it is no surprise that the failure occurs, which is actually in the very first asynchronous element of the chain, attempting to determine whether Couch is up via the&#160; "combinedStartup.isCouchUp" element.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6444/"><span class="aria-hidden">←</span> Previous: FLUID-6444</a>
        <a class="mx-1" href="/browse/FLUID-6446/">Next: FLUID-6446 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>