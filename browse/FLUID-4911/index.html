<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-4911  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-4911 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-4911/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-4911/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-4911/">FLUID-4911</a></li>
            </ol>
        </nav>
        <h1>FLUID-4911: Remove requireStub in favor of the default pattern (logical or).</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-4911">FLUID-4911</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Task">Task</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Won't%20Fix">Won't Fix</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>N/A</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=y%20z">y z</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2013-01-29T10:42:47.300-0500" prefix="">2013-01-29T10:42:47.300-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2024-07-22T10:35:31.637-0400" prefix="">2024-07-22T10:35:31.637-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>5.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Framework</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>Infusion's Node.js module ships with requireStub.js, which is currently used in the GPII universal repository to enable our tests to run in both Node.js and in the browser. Its purpose is primarily to provide a stubbed version of Node.js's require() function, mapping between module names and global namespace names (e.g. "infusion" -&gt; fluid).</p>
<p>Colin suggested that it would be simpler to just use the following boilerplate when accessing modules that are designed to work and be tested in both the browser and Node:</p>
<p>var globalName = globalName || require("moduleName");</p>
<p>Using this idiom avoids the need for requireStub.js, so it can be removed from Infusion.</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-13461">
                        <p class="mb-0"><b>Colin Clark</b> <i>commented <relative-time datetime="2013-01-31T16:36:18.595-0500">2013-01-31T16:36:18.595-0500</relative-time></i></p>
                        <p>Reviewed, pushed and merged into master at 3a4ef0aaa7edc299fa27936ccf8ec5aa7c2bd449</p>

                    </li>
                    
                    <li id="comment-13463">
                        <p class="mb-0"><b>y z</b> <i>commented <relative-time datetime="2013-02-24T04:12:07.466-0500">2013-02-24T04:12:07.466-0500</relative-time></i></p>
                        <p>It looks like after all we need a browser version of node's require. Specifically in cases where we require a library that does not contain any of the boilerplate code that addresses multiple environments.</p>

                    </li>
                    
                    <li id="comment-13466">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2013-03-06T03:24:34.233-0500">2013-03-06T03:24:34.233-0500</relative-time></i></p>
                        <p>Summary of our thinking on this:</p>
<p>During the San Diego Hackathon, we made some attempts to find a universal solution for browser-based testing. This was initially prompted by failure of the XMLSettingsHandler which was seeming likely to be hard to debug in node-inspector, given its 10-frame stack limit. However, we did not actually try to do this before auditioning various replacements for "require in the browser". Our initial hopeful requirement was that we could gain good mocks for essentially everything inside node's environment, which might enable browser-based testing of Kettle apps. Since <a href="https://github.com/substack/node-browserify">https://github.com/substack/node-browserify</a> promised support for loading some core node modules, its emulated "require" seemed helpful.</p>
<p>Unfortunately neither this nor any other solution provided enough support, for example, to produce a mock "http.createServer" and so browser-based running of any express applications seems currently impossible. This only increases the urgency to hide "express-isms" which appear inside Kettle including any "middleware" which we end up interacting with.</p>
<p>Separately we debugged the XMLSettingsHandler issue which turned out to be caused by several bugs in its implementation. However, we continued the search for browser-based "require" implementations, finally fixing upon this one <a href="https://github.com/letorbi/Jay">https://github.com/letorbi/Jay</a> as proving by far the most minimal - around 80 lines of code (several, including wire's "curl" were more than 10 times the size). This was appropriate since we only require lightweight support for testing purposes and do not expect the implementation to be scalable or performant. In particular, the client-side use of "synchronous AJAX" allows us to emulate the natural semantics of node's "require" without distorting the client code with callback wrappers. A proper solution would use AMD <a href="http://requirejs.org/docs/whyamd.html">http://requirejs.org/docs/whyamd.html</a> or something similar but we are not yet prepared to move away from our standard use of script tags when developing and debugging the framework.</p>
<p>At this point we temporarily shelved our efforts again, since we considered that it would be impractical to expect to support browser-based use of libraries which did not follow, for example, cujo's "when.js" helpful pattern of using the AMD boilerplate which resulted in "a global with the same name as the library" when directly included in the browser. </p>
<p>However, recent pushes of Yura's fixes to jqUnit have resurfaced the issue. It appears it will be impossible to deliver on test cases which run in BOTH node.js and the browser without modifications without some form of browser-based require. This is not only because of dependencies on 3rd-party libraries such as node's "path", which are not packaged in the browser-friendly AMD-ish form, but also because of dependencies amongst the codebase itself. For example, here is the beginning of CanopyMatchMakerTests.js, under the "default pattern" mentioned in the headline of this JIRA:</p>
<pre><code class="hljs language-java"><span class="hljs-type">var</span> <span class="hljs-variable">fluid</span> <span class="hljs-operator">=</span> fluid || require(<span class="hljs-string">"infusion"</span>);

(function () {
    <span class="hljs-string">"use strict"</span>;

    <span class="hljs-type">var</span> <span class="hljs-variable">gpii</span> <span class="hljs-operator">=</span> fluid.registerNamespace(<span class="hljs-string">"gpii"</span>);

....

    <span class="hljs-type">var</span> <span class="hljs-variable">canopy</span> <span class="hljs-operator">=</span> gpii.matchMaker.canopy; &lt;-- failure here, since gpii is not actually loaded in <span class="hljs-built_in">this</span> test in node.js without <span class="hljs-string">"require"</span>
</code></pre>
<p>As background, this is a test written initially to run in the BROWSER. When updated for the current state of node-jqUnit and the "default pattern" it now runs in the browser again - however, it does not run in node since it does not issue any request for require("gpii") which would be required for node.js to resolve the dependency on the code under test. In the browser, we can paper over this issue by manually including references to all the code under test.</p>
<p>This seems to point to the fact that a browser-based implementation of "require", relying as the previous implementation did, on a statically included mapping of module names onto relative filesystem paths, is essential to progress with cross-environment testing - and if we do this, we may as well fix it up to allow fluid to self-resolve, removing the need for the "logical or" default pattern.</p>
<p>Investigation of the "Jay" version of require shows that it still shows excess implementation for our needs - it includes support for asynchronous loading, as well as a scheme for munging required module names into relative URLs, both of which are unnecessary - and is still missing the crucial feature of the JSON lookup table of module names onto file paths. </p>
<p>It is proposed that we i) revive the implementation previously known as "requireStub.js" and improve it with the use of synchronous AJAX so that it is capable of loading non-global-aware code, as well as the implementation's own code and the Fluid framework itself<br>
ii) aggressively pursue the removal of express-isms in Kettle as well as suitable mocks for dataSources and other dependencies so that essentially all of the GPII becomes effectively testable within the browser.</p>
<p>Our discussion of the debugging issues suggested there was evidence that the 10 stack-frame limit in node-inspector was held in node.js itself. Even if we could fix that, node debugging still seems a dubious prospect since the node-inspector project has now been drifting without maintenance for nearly a year. Pursuing ii) would improve the architecture of the code in any case, even if node debugging one day became a convenient option.</p>
<p>Improved work on moving Infusion's build into "grunt" might mitigate a number of these issues and ease the work of moving over to AMD/require.js if we thought desirable.</p>

                    </li>
                    
                    <li id="comment-13471">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2022-07-07T08:41:00.583-0400">2022-07-07T08:41:00.583-0400</relative-time></i></p>
                        <p>All of the elements referred to here have ceased to exist in their forms of 2013 as well as the ES6 module specification creating entirely new kinds of issues.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-4908/"><span class="aria-hidden">←</span> Previous: FLUID-4908</a>
        <a class="mx-1" href="/browse/FLUID-4912/">Next: FLUID-4912 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>