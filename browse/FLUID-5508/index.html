<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-5508  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-5508 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-5508/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-5508/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-5508/">FLUID-5508</a></li>
            </ol>
        </nav>
        <h1>FLUID-5508: Grade resolution algorithm contributes multiple copies of listeners when grade is available through multiple paths</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-5508">FLUID-5508</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Fixed">Fixed</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2014-09-12T19:19:56.770-0400" prefix="">2014-09-12T19:19:56.770-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2016-08-18T11:43:10.646-0400" prefix="">2016-08-18T11:43:10.646-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>1.5</li>
                            
                            <li>2.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>2.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>IoC System</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>The current implementation of the grade merging algorithm (as specified and resolved in <a href="/browse/FLUID-5085/">FLUID-5085</a>) leads to incorrect results in the case of listener contribution, where the same grade is available through multiple paths in the grade hierarchy. For example, the following definitions inherit multiple times from "flock.synth":</p>
<pre><code class="hljs language-java">fluid.defaults(<span class="hljs-string">"colin.greenwichPark.mutedSynth"</span>, {
        gradeNames: [<span class="hljs-string">"flock.synth"</span>, <span class="hljs-string">"autoInit"</span>],
        synthDef: {
            id: <span class="hljs-string">"main"</span>
        }
    });

            ukeClock: {
                type: <span class="hljs-string">"colin.greenwichPark.ukeClock"</span>,
                options: {
                    gradeNames: [<span class="hljs-string">"colin.greenwichPark.mutedSynth"</span>]
                }
            }
</code></pre>
<p>where flock.synth has</p>
<pre><code class="hljs language-java">fluid.defaults(<span class="hljs-string">"flock.synth"</span>, {
        gradeNames: [<span class="hljs-string">"flock.node"</span>, <span class="hljs-string">"flock.ugenNodeList"</span>, <span class="hljs-string">"autoInit"</span>],
....

        listeners: {
            onCreate: {
                funcName: <span class="hljs-string">"flock.synth.addToEnvironment"</span>,
                args: [<span class="hljs-string">"{that}"</span>, undefined, <span class="hljs-string">"{that}.options"</span>, <span class="hljs-string">"{that}.enviro"</span>]
            },
</code></pre>
<p>In this case, instantiation of the "ukeClock" subcomponent will end up contributing two copies of the "addToEnvironment" listener to its onCreate event.</p>
<p>This is what the current <a href="/browse/FLUID-5085/">FLUID-5085</a> algorithm requires - since each additional copy of the grade's definition must indeed be added to the end of its merging grade chain. In the case of plain values this has a reasonable effect - later copies of the grade's values simply override the earlier values, which in most cases leaves them unchanged. In the case of listeners without a namespace, the effect is undesirable - our semantic requires these to be additive.</p>
<p>The only clear way which currently appears to resolve this situation is to special-case it in the framework (this is undesirable, but listener merging already involves a considerable amount of custom code). The framework should generate unique ids for each listener record as they enter the grade definitions (as it currently does for the synthesized "componentSource" field) and the listener record merging algorithm should discard any such duplicates. </p>
<p>Other cases where such problems could arise involve the use of custom mergePolicies which could create other sites with "accumulative" semantics. It's unclear we can solve this issue any more generally without thinking even harder about the <a href="/browse/FLUID-5085/">FLUID-5085</a> semantics. </p>
<p>However, one route by which we can aid users to create such "mixin" grades is to create a standard "fluid.component" grade with absolutely no contents, which is used wherever we apply "unbound" or other such mixins to make a grade "as empty as possible" of possibly re-overriding material (for example, "fluid.littleComponent" harbours a danger, since it might overwrite an argumentMap contributed by a "fluid.viewComponent" earlier in the chain).</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-22331">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2014-11-18T20:16:36.890-0500">2014-11-18T20:16:36.890-0500</relative-time></i></p>
                        <p>I felt sure that some work had been done on this issue, but there seems to be none. Note that the framework automatically supplies a synthesized member "componentSource" to each listener record, which is currently used only for the relatively worthless requirement of synthesizing soft namespace names. It appears that given this is invoked directly from fluid.rawDefaults, that it is actually suitable for this purpose - the name of the field is slightly misleading. There seems huge scope for confusion with this implementation since the rules for "collision of soft namespaces" (which is to behave as if there is no collision and register both listeners) directly conflict with the rules apparently required by this JIRA (collision actually causes replacement). As the JIRA observes, it is the exact listener record itself which must be tagged, and in an entirely unique way - as opposed to the human-readable "woolly" way which leads to the soft namespace string.</p>

                    </li>
                    
                    <li id="comment-22333">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2015-08-20T16:11:07.867-0400">2015-08-20T16:11:07.867-0400</relative-time></i></p>
                        <p>Listeners are now fully tagged with "componentSource" annotations as part of the <a href="/browse/FLUID-5733/">FLUID-5733</a> work - this should be easy to resolve if it is not already</p>

                    </li>
                    
                    <li id="comment-22337">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2015-09-07T16:07:22.066-0400">2015-09-07T16:07:22.066-0400</relative-time></i></p>
                        <p>A further and more intractable version of this issue has transpired with respect to "members". The user has a grade (ironically the same one as in this headline JIRA) named "flock.synth" which contains a highly expensive "members" definition. This definition is contributed twice, which is undesirable. This has regressed as a result of the stopgap fix for <a href="/browse/FLUID-5668/">FLUID-5668</a>. "members" no longer follow the default workflow for grade merging, which operates MERGING BEFORE EXPANSION. Instead, especially since the "model" area of components we still attempt to implement as a standard "member", we needed to take control of the expansion behaviour manually. Also, a case emerged (the <a href="/browse/FLUID-5668/">FLUID-5668</a> case) where a kind of "proto model" was assembled from various contributions - where merging after expansion was clearly required.<br>
It's hard to see a clear way out of this - perhaps only by significantly improving both the "members" workflow as well as our support for mergePolicies which will allow user's policies in this respect to be expressed clearly.</p>

                    </li>
                    
                    <li id="comment-22340">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2015-09-07T16:19:43.398-0400">2015-09-07T16:19:43.398-0400</relative-time></i></p>
                        <p>As a current experiment, adding a mergePolicy of "members.synthDef": "replace" had no effect on the double contribution</p>

                    </li>
                    
                    <li id="comment-22341">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2016-08-18T10:01:01.228-0400">2016-08-18T10:01:01.228-0400</relative-time></i></p>
                        <p>This was effectively fixed with the <a href="/browse/FLUID-5800/">FLUID-5800</a> fix in <a href="https://github.com/fluid-project/infusion/pull/648">https://github.com/fluid-project/infusion/pull/648</a> although we still have a good deal of work required in this area for <a href="/browse/FLUID-5668/">FLUID-5668</a> and related issues</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-5507/"><span class="aria-hidden">←</span> Previous: FLUID-5507</a>
        <a class="mx-1" href="/browse/FLUID-5509/">Next: FLUID-5509 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>