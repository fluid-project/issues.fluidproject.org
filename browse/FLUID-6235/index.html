<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-6235  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-6235 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-6235/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-6235/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-6235/">FLUID-6235</a></li>
            </ol>
        </nav>
        <h1>FLUID-6235: Default merging of expanded options is not consistent...</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-6235">FLUID-6235</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Task">Task</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Duplicate">Duplicate</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Tony%20Atkins%20%5BRtF%5D">Tony Atkins [RtF]</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2018-01-02T07:20:38.711-0500" prefix="">2018-01-02T07:20:38.711-0500</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2024-07-22T09:00:28.722-0400" prefix="">2024-07-22T09:00:28.722-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>Framework</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>I have recently been working with expanded defaults (for example, defaulting a directory path to a generated subdirectory of a temp directory.  In grades that extend the base grade, I usually want to replace the expanded material with literal options.  This led me to discover a few oddities.  Take a look at this example:</p>
<pre><code class="hljs language-java"><span class="hljs-comment">/* eslint-env node */</span>
<span class="hljs-string">"use strict"</span>;
<span class="hljs-type">var</span> <span class="hljs-variable">fluid</span> <span class="hljs-operator">=</span> require(<span class="hljs-string">"infusion"</span>);
<span class="hljs-type">var</span> <span class="hljs-variable">my</span> <span class="hljs-operator">=</span> fluid.registerNamespace(<span class="hljs-string">"my"</span>);

fluid.registerNamespace(<span class="hljs-string">"my.base.grade"</span>);
my.base.grade.expander = function (payload) {
    <span class="hljs-keyword">return</span> payload;
};

fluid.defaults(<span class="hljs-string">"my.base.grade"</span>, {
    gradeNames: [<span class="hljs-string">"fluid.component"</span>],
    <span class="hljs-comment">// mergePolicy: {</span>
    <span class="hljs-comment">//     expanded: "nomerge"</span>
    <span class="hljs-comment">// },</span>
    expanded: {
        object: {
            expander: {
                func: <span class="hljs-string">"my.base.grade.expander"</span>,
                args: [{ fromBase: <span class="hljs-literal">true</span> }]
            }
        },
        array: {
            expander: {
                func: <span class="hljs-string">"my.base.grade.expander"</span>,
                args: [[<span class="hljs-string">"fromBase"</span>]]
            }
        },
        simpleValue: {
            expander: {
                func: <span class="hljs-string">"my.base.grade.expander"</span>,
                args: [<span class="hljs-string">"fromBase"</span>]
            }
        }
    }
});

fluid.defaults(<span class="hljs-string">"my.extended.grade"</span>, {
    gradeNames: [<span class="hljs-string">"my.base.grade"</span>],
    expanded: {
        object: {
            fromExtended: <span class="hljs-literal">true</span>
        },
        array: [<span class="hljs-string">"fromExtended"</span>],
        simpleValue: <span class="hljs-string">"fromExtended"</span>
    }
});

<span class="hljs-type">var</span> <span class="hljs-variable">extendedComponent</span> <span class="hljs-operator">=</span> my.extended.grade();
console.log(<span class="hljs-string">"Using Options Merging:\n"</span>, JSON.stringify(extendedComponent.options.expanded, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));

<span class="hljs-comment">/*

    Using Options Merging:

    {
        "object": {
            "fromBase": true
        },
        "array": [
            "fromBase"
        ],
        "simpleValue": "fromExtended"
    }

*/</span>

fluid.defaults(<span class="hljs-string">"my.iocRef.grade"</span>, {
    gradeNames: [<span class="hljs-string">"my.base.grade"</span>],
    newObject: { fromExtended: <span class="hljs-literal">true</span>},
    newArray: [<span class="hljs-string">"fromExtended"</span>],
    newSimpleValue: <span class="hljs-string">"fromExtended"</span>,
    expanded: {
        object: <span class="hljs-string">"{that}.options.newObject"</span>,
        array: <span class="hljs-string">"{that}.options.newArray"</span>,
        simpleValue: <span class="hljs-string">"{that}.options.newSimpleValue"</span>
    }
});

<span class="hljs-type">var</span> <span class="hljs-variable">iocComponent</span> <span class="hljs-operator">=</span> my.iocRef.grade();
console.log(<span class="hljs-string">"Using IoC Refs:\n"</span>, JSON.stringify(iocComponent.options.expanded, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));

<span class="hljs-comment">/*

    Using IoC Refs:
    {
        "object": {
            "fromExtended": true
        },
        "array": [
            "fromExtended"
        ],
        "simpleValue": "fromExtended"
    }

*/</span>
</code></pre>
<p>There may be a very real reason for the base grade to "win" during the expansion and merging process, but the net effect is a bit confusing:</p>
<p>1. Expanded options from a base grade are simply replaced if they represent a literal value.<br>
2. Expanded options from a base grade are not replaced if they are objects or arrays.<br>
3. IoC references can be used to replace the underlying expanded options.</p>
<p>If this is the intended behaviour, it should be better explained with an example in the expansion and/or <a href="https://docs.fluidproject.org/infusion/development/OptionsMerging.html#structure-of-the-merge-policy-object">merge policy docs</a>.  For example:</p>
<blockquote>
<p>By default if there is no policy specified, a deep merge is done together with expansion. Firstly, any IoC references and expanders in the source objects will be expanded. Secondly, everything in the source objects are copied over the target object, in a manner very similar to the operation of the jQuery API method $.extend(true, ...). Anything that existed in the target but was not present in any of the source objects will continue to be present in the resulting merged object.</p>
</blockquote>
<p>On reading this, I would expect the base grade's options to have been expanded, and then merged with the child grade's options, including resolving IoC references, such that in both child grades <code>options.expanded.object</code> would be: </p>
<pre><code class="hljs language-java">{
  fromBase: <span class="hljs-literal">true</span>,
  fromExtended: <span class="hljs-literal">true</span>
}
</code></pre>
<p>The inconsistencies can be mitigated somewhat using merge policies for expanded options, i.e. you can specific a merge policy of "nomerge" that will ensure the "child" grade's options will be used.  However, this does not cover the case above, in which we wish to inherit generated options and merge them with individual options of our choosing.</p>
<p>cc: Antranig Basman</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-19249">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2018-01-03T07:31:19.595-0500">2018-01-03T07:31:19.595-0500</relative-time></i></p>
                        <p>This is a well-known oddity with options expansion and is a duplicate of <a href="/browse/FLUID-6219/">FLUID-6219</a> - it recently tripped over the ASTEA team. It will be addressed in the framework rewrite after the next one.</p>

                    </li>
                    
                    <li id="comment-19253">
                        <p class="mb-0"><b>Tony Atkins [RtF]</b> <i>commented <relative-time datetime="2018-01-03T09:38:49.825-0500">2018-01-03T09:38:49.825-0500</relative-time></i></p>
                        <p>Thanks, Antranig Basman.  I'll close this one as a duplicate.</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-6234/"><span class="aria-hidden">←</span> Previous: FLUID-6234</a>
        <a class="mx-1" href="/browse/FLUID-6236/">Next: FLUID-6236 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>