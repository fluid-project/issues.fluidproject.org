<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-scheme="light">
    <head>
        <title> FLUID-5931  | Fluid Project Issues Archive</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta name="description" content="Archive of Fluid Project issues from the JIRA issue tracker">
        <meta property="og:title" content=" FLUID-5931 |  Fluid Project Issues Archive">
        <meta property="og:description" content="Archive of Fluid Project issues">
        <meta property="og:locale" content="en">
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://issues.fluidproject.org/browse/FLUID-5931/">
        <link rel="canonical" href="https://issues.fluidproject.org/browse/FLUID-5931/">


        <link rel="stylesheet" href="/assets/styles/style.css">

        
<script type="module" src="/assets/scripts/relative-time/bundle.js"></script>

    </head>
    <body class="page-issue">
        <header class="mt-3">
            <a class="skip-link" href="#main">Skip to Content</a>
            <nav aria-label="main menu">
                <menu>
                    <li><a rel="home" href="/">Home</a></li>
                    <li><a href="/search/">Search</a></li>
                </menu>
            </nav>
            
        <nav aria-label="breadcrumbs">
            <ol>
                <li><a rel="home" href="/">Home</a></li>
                <li><a href="/projects/FLUID" data-pagefind-filter="project">Fluid Infusion</a></li>
                <li><a href="/browse/FLUID-5931/">FLUID-5931</a></li>
            </ol>
        </nav>
        <h1>FLUID-5931: afterDestroy event fires too soon</h1>

        </header>
        <main id="main">
            
    <div id="content" class="content with-sidebar">
        <div class="spacing-y-1 bg-default">
            <h2>Metadata</h2>
            <dl>
                <div>
                    <dt>Source</dt>
                    <dd><a href="https://fluidproject.atlassian.net/browse/FLUID-5931">FLUID-5931</a></dd>
                </div>
                <div>
                    <dt>Type</dt>
                    <dd>
                        <a href="/projects/FLUID/?type=Bug">Bug</a>
                    </dd>
                </div>
                <div>
                    <dt>Priority</dt>
                    <dd>Major</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>Closed</dd>
                </div>
                <div>
                    <dt>Resolution</dt>
                    <dd>
                            <a href="/projects/FLUID/?resolution=Fixed">Fixed</a>
                        
                    </dd>
                </div>
                <div>
                    <dt>Assignee</dt>
                    <dd>Antranig Basman</dd>
                </div>
                <div>
                    <dt>Reporter</dt>
                    <dd>
                        <a href="/projects/FLUID/?reporter=Antranig%20Basman">Antranig Basman</a>
                    </dd>
                </div>
                <div>
                    <dt>Created</dt>
                    <dd><relative-time datetime="2016-07-20T10:00:16.741-0400" prefix="">2016-07-20T10:00:16.741-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Updated</dt>
                    <dd><relative-time datetime="2016-10-20T13:31:52.990-0400" prefix="">2016-10-20T13:31:52.990-0400</relative-time></dd>
                </div>
                <div>
                    <dt>Versions</dt>
                    <dd>
                        
                        N/A
                        
                    </dd>
                </div>
                <div>
                    <dt>Fixed Versions</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>2.0</li>
                            
                        </ol>
                        
                    </dd>
                </div>
                <div>
                    <dt>Component</dt>
                    <dd>
                        
                        <ol role="list">
                            
                            <li>IoC System</li>
                            
                        </ol>
                        
                    </dd>
                </div>
            </dl>
        </div>

        <div>
            <div class="spacing-y-1">
                <h2>Description</h2>
                <p>The framework's "afterDestroy" event should only fire after <strong>all</strong> user-visible effects accompanying a component's destruction have completed. In the current body of fluid.clearComponent there are several crucial effects which occur after this point - </p>
<p>i) The deletion of the shadow<br>
ii) Tidying up the component' IoC resolution scope<br>
iii) Removing the component from pathToComponent records<br>
iv) Actually detaching the component from its parent</p>
<p>Of these, iii) and iv) are fatally mistimed. The workflow we would like is to be able to fire the createOnEvent event for a component from its afterDestroy listener in order to recreate it. This emerged from the work on <a href="/browse/GPII-580/">GPII-580</a> where we destroy a server from within one of its settingsHandlers. In the following configuration:</p>
<pre><code class="hljs language-java">}, {
                func: <span class="hljs-string">"{loginRequest}.send"</span>
            }, { <span class="hljs-comment">// As a result of the exploding settings handler, the attempt to login will destroy the server</span>
                event: <span class="hljs-string">"{configuration}.server.events.afterDestroy"</span>,
                listener: <span class="hljs-string">"gpii.tests.journal.logDestroyed"</span>,
                args: <span class="hljs-string">"{loginRequest}"</span>
            },
            kettle.test.startServerSequence
</code></pre>
<p>the startServerSequence if entered synchronously will try to reconstruct the server component - unfortunately it will trigger a fresh "clearComponent" for it whilst the existing one is still in progress since it has not yet been cleared from its parent (iv) during either onDestroy or afterDestroy</p>

            </div>
            
            
            
            
            <div class="spacing-y-1">
                <h2>Comments</h2>
                <ul class="spacing-y-2" role="list">
                    
                    <li id="comment-22595">
                        <p class="mb-0"><b>Antranig Basman</b> <i>commented <relative-time datetime="2016-08-02T19:08:15.309-0400">2016-08-02T19:08:15.309-0400</relative-time></i></p>
                        <p>This was a more awkward issue than expected. In practice, there has been a bit of "magic"/sloppiness which allowed IoC-resolved arguments to an "afterDestroy" listener to resolve at all - which in theory should not have been possible given the component has been destroyed. There were some guards within fluid.expander.fetch which attempted to prevent this but they were not tripped in many cases.</p>
<p>There were a few possibilities for resolving this. Firstly, the action of reconstructing the component could have been deferred - by some magic mechanism spotting that the component in the current position was in a new lifecycleStatus "destroyed" and thus queuing up the recreation "asynchronously". Secondly, we could have split the action of resolving an "afterDestroy" listener - that is, resolve all IoC references within the listener first, then honour the destruction, then actually invoke the listener.</p>
<p>Both of these methods would have done too much violence to the framework implementation. There is simply too much reliance on the fact that IoC references are resolved "on the spot" - within the implementation of the relevant invoker/listener, and it's hard to think of a performant way of doing anything about this. Either we duplicate the code at each of these sites, or else create a garbage function handle on each invocation. The first method relies on a framework "scheduler" and creates too much of a precedent for <a href="/browse/FLUID-4982/">FLUID-4982</a> behavior before the fact.</p>
<p>In practice we fudged the issue somewhat, and carefully scheduled the destruction of some framework records (the actual member of "that" and records in pathToComponent) BEFORE afterDestroy, and some others (the actual shadow record in idToShadow) AFTERWARDS. This means that normal IoC resolution (with some tweaking, to defeat the ginger process as during mature life) can proceed for these arguments, at the same time as the component's member slot in its parent already being vacated ready for a possible reconstruction.</p>

                    </li>
                    
                    <li id="comment-22598">
                        <p class="mb-0"><b>Cindy Li</b> <i>commented <relative-time datetime="2016-10-20T13:31:46.220-0400">2016-10-20T13:31:46.220-0400</relative-time></i></p>
                        <p>The pull request <a href="https://github.com/fluid-project/infusion/pull/730">https://github.com/fluid-project/infusion/pull/730</a> has been merged into the master branch at 2ae5da176294899a2c73b333aa27bdefeaa33b80</p>

                    </li>
                    
                </ul>
            </div>
            
        </div>
    </div>

        </main>
        <footer>
            
<nav aria-labelledby="pagination">
    <h2 class="visually-hidden">pagination</h2>
    <p class="flex">
        
        
        <a class="mx-1" href="/browse/FLUID-5930/"><span class="aria-hidden">←</span> Previous: FLUID-5930</a>
        <a class="mx-1" href="/browse/FLUID-5932/">Next: FLUID-5932 <span class="aria-hidden">→</span></a>
    </p>
</nav>

        </footer>
    </body>
</html>